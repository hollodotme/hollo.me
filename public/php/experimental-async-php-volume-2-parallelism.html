<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>Q/A: Parallelism, Experimental async PHP - VOL. 2 | Holger Woltersdorf&#039;s blog</title>
	<meta name="description" content="Why is execution of workers parallelised in the system shown in Experimental async PHP - VOL. 2.?">
	<meta name="keywords" content="Q&amp;A, question, answer, PHP, async, php-fpm, redis, publish, subscribe, pubsub, experimental, daemon, worker, socket, parallelism">
	<meta name="HandheldFriendly" content="True"/>
	<meta name="geo.region" content="DE-SN"/>
	<meta name="geo.placename" content="Dresden"/>
	<meta name="geo.position" content="51.052088;13.741672"/>
	<meta name="ICBM" content="51.052088, 13.741672"/>
	<meta name="twitter:site" content="@hollodotme">
	<meta name="twitter:creator" content="@hollodotme">
	<script type="application/ld+json">{
  "@context" : "http://schema.org",
  "@type": "Person",
  "name": "Holger Woltersdorf&#039;s blog",
  "image": "https://dev.hollo.me/img/posts/caller-rabbitmq-daemon-socket-worker.png",
  "url": "https://dev.hollo.me",
  "sameAs" : [
      "https://twitter.com/hollodotme",
      "https://www.xing.com/profile/Holger_Woltersdorf"
    ]
  }
}</script>
	<meta property="article:author" content="https://www.xing.com/profile/Holger_Woltersdorf"/>
	<meta property="article:publisher" content="https://www.xing.com/profile/Holger_Woltersdorf"/>
	<link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
	<link rel="manifest" href="/favicon/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">

	<link rel="canonical" href="https://dev.hollo.me/php/experimental-async-php-volume-2-parallelism.html"/>
	<meta name="referrer" content="origin"/>

	<meta property="og:site_name" content="Holger Woltersdorf&#039;s blog"/>
	<meta property="og:type" content="article"/>
	<meta property="og:title" content="Q/A: Parallelism, Experimental async PHP - VOL. 2 | Holger Woltersdorf&#039;s blog"/>
	<meta property="og:description" content="Why is execution of workers parallelised in the system shown in Experimental async PHP - VOL. 2.?"/>
	<meta property="og:url" content="https://dev.hollo.me"/>
	<meta property="og:image" content="https://dev.hollo.me/img/posts/caller-rabbitmq-daemon-socket-worker.png"/>
	<meta property="article:published_time" content="2019-10-07T07:21:33+00:00"/>
	<meta property="article:modified_time" content="2019-10-07T07:21:33+00:00"/>
			<meta property="article:tag" content="Q&amp;A"/>
			<meta property="article:tag" content="question"/>
			<meta property="article:tag" content="answer"/>
			<meta property="article:tag" content="PHP"/>
			<meta property="article:tag" content="async"/>
			<meta property="article:tag" content="php-fpm"/>
			<meta property="article:tag" content="redis"/>
			<meta property="article:tag" content="publish"/>
			<meta property="article:tag" content="subscribe"/>
			<meta property="article:tag" content="pubsub"/>
			<meta property="article:tag" content="experimental"/>
			<meta property="article:tag" content="daemon"/>
			<meta property="article:tag" content="worker"/>
			<meta property="article:tag" content="socket"/>
			<meta property="article:tag" content="parallelism"/>
		<meta name="twitter:card" content="summary_large_image"/>
	<meta name="twitter:title" content="Q/A: Parallelism, Experimental async PHP - VOL. 2 | Holger Woltersdorf&#039;s blog"/>
	<meta name="twitter:description" content="Why is execution of workers parallelised in the system shown in Experimental async PHP - VOL. 2.?"/>
	<meta name="twitter:url" content="https://dev.hollo.me/php/experimental-async-php-volume-2-parallelism.html"/>
	<meta name="twitter:image:src" content="https://dev.hollo.me/img/posts/caller-rabbitmq-daemon-socket-worker.png"/>

	<meta name="generator" content="IceHawk Static Page Generator"/>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<link href="https://fonts.googleapis.com/css?family=Oxygen|Oxygen+Mono" rel="stylesheet">
	<link rel="stylesheet" type="text/css" media="screen" href="https://dev.hollo.me/css/theme.css">
	<script src="https://use.fontawesome.com/3513f09ab7.js"></script>
	</head>
<body>
<div class="themewrapper">

	<a href="#" id="sidebar-toggle"><i class="fa fa-close genericon"></i></a>

	<div id="sidebar">
		<div class="brand-well">
			<a href="https://dev.hollo.me">
				<img src="https://dev.hollo.me/img/hwoltersdorf_blue_500x500.png" alt="Holger Woltersdorf">
			</a>
		</div>

		<h3 class="text-center text-uppercase">Holger Woltersdorf</h3>
		<p class="text-center text-uppercase subline">
			CIO &middot; Developer &middot; Speaker<br>
			PHP &middot; WEB &middot; Community
		</p>

		<hr>

		<ul class="sociallinks">
			<li>
				<a href="https://twitter.com/hollodotme" title="Holger Woltersdorf on twitter (@hollodotme)" target="_blank"><i class="fa fa-twitter"></i></a>
			</li>
			<li>
				<a href="https://www.xing.com/profile/Holger_Woltersdorf" title="Holger Woltersdorf on Xing" target="_blank"><i class="fa fa-xing"></i></a>
			</li>
			<li>
				<a href="https://github.com/hollodotme" title="Holger Woltersdorf on GitHub" target="_blank"><i class="fa fa-github"></i></a>
			</li>
			<li>
				<a href="https://www.linkedin.com/in/holgerwoltersdorf" title="Holger Woltersdorf on LinkedIn" target="_blank"><i class="fa fa-linkedin"></i></a>
			</li>
		</ul>

		<hr>

		<ul class="sidebar-nav">
			<li class="hidden-sm hidden-md hidden-lg">
				<a href="https://dev.hollo.me/" title="Home">Home</a>
			</li>
			
						<li class="active">
		<a href="https://dev.hollo.me/php.html">PHP</a>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/talks.html">Talks</a>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/projects.html">Projects</a>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/devops.html">DevOps</a>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/reading-list.html">Reading list</a>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/imprint.html">Imprint</a>
			</li>


						<li>
				<a href="https://www.papercall.io/speakers/hollodotme" target="_blank" title="My profile on papercall.io">
					PaperCall.io profile
				</a>
			</li>
			<li>
				<a href="https://speakerdeck.com/hollodotme" target="_blank" title="My profile on speakerdeck.com">
					SpeakerDeck profile
				</a>
			</li>
		</ul>

		<hr>

		<div class="text-center">
			<p>
				<small>Co-Founder of</small>
			</p>
			<a href="http://phpug-dresden.org" target="_blank">
				<img src="https://dev.hollo.me/img/php-usergroup-dresden.png" alt="PHP USERGROUP DRESDEN e.V." class="img img-50">
			</a>
		</div>

		<hr>

		<p class="text-center">
			<strong>Found a bug or a typo?</strong><br>
			This website is open source,<br>
			<a href="https://github.com/hollodotme/hollo.me" target="_blank" title="Website GitHub repository">please fork it and provide a PR</a>.
		</p>
		<p class="text-center website-version">
			<small>v1.2.1</small>
		</p>

	</div>

	<div id="breadcrumbs">
		<ul>
												<li>
						<a href="https://dev.hollo.me/index.html">
							<i class="fa fa-map-marker"></i> Home
						</a>
					</li>
																<li>
						<a href="https://dev.hollo.me/php.html">
							 PHP
						</a>
					</li>
																<li>
						<a href="https://dev.hollo.me/php/experimental-async-php-volume-2.html">
							 Experimental async PHP - VOL. 2
						</a>
					</li>
																<li class="active">
						 Q/A: Parallelism
					</li>
									</ul>
	</div>

	<div id="main">

		
			<h1>Q/A: Parallelism, Experimental async PHP - VOL. 2</h1>
			<h5>Why is execution of workers parallelised in the system shown in Experimental async PHP - VOL. 2.?</h5>
			<hr>

			<h2>Question</h2>
<p>Today <i class="fa fa-twitter"></i> <a href="https://twitter.com/yourithielen">Youri Thielen</a> came up with the following question regarding my post on <a href="https://dev.hollo.me/php/experimental-async-php-volume-2.html">Experimental async PHP - VOL. 2</a>:</p>
<blockquote>
<p>Awesome, looks pretty workable, will probably run some experiments with this! Just out of interest, how do you achieve the parallel
streams? I see stream_socket_client but no stream_set_blocking. I see you use PHPs yield, that's how you achieve 'parallelism' right?</p>
</blockquote>
<hr />
<h2>Answers</h2>
<p><a href="https://twitter.com/hollodotme/status/909484318522822663">See my original answer in this twitter thread.</a></p>
<h3>Using yield</h3>
<p>In this case <code>yield</code> is used as an iterator and has therefor nothing to to with parallelism.<br />
I recommend reading <a href="http://blog.kelunik.com/2017/09/14/an-introduction-to-generators-in-php.html">this blog post</a>
by <i class="fa fa-twitter"></i> <a href="https://twitter.com/kelunik">Niklas Keller</a> which explains the different use-cases of
generators and yield in PHP.</p>
<h3>Understanding PHP-FPM</h3>
<p>To understand why the workers are executed in parallel, you first need to understand how PHP-FPM works.</p>
<p>PHP-FPM organizes it's processes in so-called pools, which can be easily configured and added. <a href="#adding-php-fpm-pools">See example below.</a>
Each pool is represented by a master process that is listening on a particular socket (network or unix domain socket).
This master process queues incoming requests, spawns child processes in background, distributes the workload to its child processes
and writes the responses back to the socket/stream as soon as the child processes finished and handed over their results. </p>
<p>A pool defines how child-processes are spawned, how much of them can be alive at the same time, and how/when they die.</p>
<p>PHP-FPM uses the <a href="http://www.mit.edu/~yandros/doc/specs/fcgi-spec.html">FastCGI protocol</a> for the socket communication.</p>
<p>If you are using PHP-FPM for your web application this process list should look familiar to you.</p>
<pre><code class="language-bash">root      Ss   Sep16   0:05 php-fpm: master process (/etc/php/7.1/fpm/php-fpm.conf)
www-data  S    14:01   0:00 php-fpm: pool www
www-data  S    14:01   0:00 php-fpm: pool www</code></pre>
<p>You can see that there is one master process for the pool named &quot;www&quot; and two child processes ready to handle requests.
This is more or less the default that is shipped with php (depends on your distribution).</p>
<h4>PHP-FPM pools explained</h4>
<p>A PHP-FPM pool can be added by placing a simple config file to <code>/etc/php/7.1/fpm/pool.d/&lt;POOL-NAME&gt;.conf</code>.<br />
(This path may differ depending on your distribution.)</p>
<p>The config for the pool seen above looks like this:</p>
<p><i class="fa fa-file-o"></i> <code>www.conf</code></p>
<pre><code class="language-ini">; Name of the pool
[www]

; User and group under which the child processes will run
user = www-data
group = www-data

; Socket the master process is listening to
; Could also be a network socket like 127.0.0.1:9000
listen = /run/php/php7.1-fpm.sock

; Permissions for user/group that can access the socket (only for unix domain socket relevant)
listen.owner = www-data
listen.group = www-data

; Set listen(2) backlog.
; Default Value: 511 (-1 on FreeBSD and OpenBSD)
listen.backlog = 511

; Process management type (more explanation below)
pm = dynamic

; Maximum amount of parallel child processes
pm.max_children = 5

; Amount of child processes that are always alive, even if there is nothing to do
; That's why you see 2 child processes in the process list above
; Note: Used only when pm is set to 'dynamic'
; Default Value: min_spare_servers + (max_spare_servers - min_spare_servers) / 2 
pm.start_servers = 2

; The desired minimum number of idle server processes.
; Note: Used only when pm is set to 'dynamic'
; Note: Mandatory when pm is set to 'dynamic'
pm.min_spare_servers = 1

; The desired maximum number of idle server processes.
; Note: Used only when pm is set to 'dynamic'
; Note: Mandatory when pm is set to 'dynamic'
pm.max_spare_servers = 3</code></pre>
<p><strong>Please note</strong> the <code>listen.backlog</code> setting, which defines how much requests PHP-FPM will accept until it rejects a request.
This setting implies that PHP-FPM is a request queue.</p>
<p><strong>Please also note</strong> there are more configuration options for PHP-FPM. This post only shows the essential ones. For more
information, <a href="http://php.net/manual/en/install.fpm.configuration.php">please check out the official documentation</a>.</p>
<hr />
<p>PHP-FPM knows three different types for the process management (config value for <code>pm</code>):</p>
<ol>
<li>
<p><em><strong>dynamic</strong></em> (as shown above)<br />
You can configure how many child processes are always alive to immediately handle requests without an upstart time.
This should be used when performance and quick responses are the focus of the application. That's why it is commonly
used in combination with a webserver like nginx.  </p>
</li>
<li>
<p><em><strong>ondemand</strong></em> (see example below)<br />
The configured amount of child processes will be started (only) as soon as the master process gets requests. After a certain amount of time
these child processes will die and only the master process stays alive.<br />
I personally prefer this mode for the background workers I described in my blog post,
because the quick response is not that important in this use-case.
Depending on the workload you don't want to have a lot of idle processes consuming resources for nothing.  </p>
</li>
<li><em><strong>static</strong></em><br />
You configure a fixed number of child processes. Until now I did't see a use-case for this.</li>
</ol>
<hr />
<p><a name="adding-php-fpm-pools"></a></p>
<h4>Adding PHP-FPM pools</h4>
<p>In my experimental system I used the following pool config to execute the workers in:</p>
<p><i class="fa fa-file-o"></i> <code>/etc/php/7.1/fpm/pool.d/commands.conf</code></p>
<pre><code class="language-ini">; Pool name
[commands]

; Process ownership
user = www-data
group = www-data

; Socket path
listen = /var/run/php/php7.1-fpm-commands.sock

; Socket ownership
listen.owner = www-data
listen.group = www-data

; Process management
; Choosing 'ondemand' to create children only if new processes are requested (less overhead)
pm = ondemand

; Maximum of children that can be alive at the same time
pm.max_children = 5

; Number of seconds after which an idle children will be killed
pm.process_idle_timeout = 10s

; Access log file
access.log = /var/log/php/php7.1-fpm-commands.access.log</code></pre>
<p>What did I do:</p>
<ul>
<li>I name the pool &quot;commands&quot;.</li>
<li>I defined a separate socket path (<code>/var/run/php/php7.1-fpm-commands.sock</code>) for this pool.<br />
When using a network socket, make sure to use at least another port, e.g. <code>127.0.0.1:9001</code>.</li>
<li>I set the process management mode to &quot;ondemand&quot;.</li>
<li>I allow a maximum of 5 child processes.<br />
<em>So we can have at most 5 requests being executed in parallel.</em></li>
<li>I defined that child processes should die 10 seconds after they went idle.</li>
<li>I defined a separate log file for all requests to this pool.  </li>
</ul>
<p>To add this pool to your PHP-FPM simply place the file in the aforementioned path and reload/restart your PHP-FPM service.</p>
<p>Before reloading/restarting the php-fpm service make sure the access log file exists:</p>
<pre><code class="language-bash">$ sudo mkdir -p /var/log/php
$ sudo touch /var/log/php/php7.1-fpm-commands.access.log</code></pre>
<p>Now reload/restart the php-fpm service:</p>
<pre><code class="language-bash">$ sudo service php7.1-fpm reload
# OR
$ sudo service php7.1-fpm restart</code></pre>
<hr />
<h3>Back to the question: How is parallelism achieved?</h3>
<p>Now that you learned how PHP-FPM queues and handles requests in child processes,
it should be clear that the communication with PHP-FPM always consists of to actions:</p>
<ol>
<li>
<p><strong>Write request to the PHP-FPM socket</strong>, which will be queued and eventually executed in a child process.<br />
As soon as PHP-FPM accepted the request and read its data, this action is finished and you can return to your code execution.  </p>
</li>
<li><strong>Read the response from the PHP-FPM socket</strong>, which will be available as soon as the child process finished and
handed the execution result over to the PHP-FPM master process. The master process then writes the response back
to the PHP-FPM socket. This event can be observed by using the <code>stream_select</code> function of PHP which tells you that a
stream became active.</li>
</ol>
<p>Given this, it is now possible to send multiple requests to PHP-FPM which will be executed in parallel and eventually
handling their responses.</p>
<p>That is exactly what my <a href="https://github.com/hollodotme/fast-cgi-client">fast-cgi-client</a> implementation offers when<br />
<a href="https://github.com/hollodotme/fast-cgi-client#sending-multiple-requests-and-reading-their-responses-reactive">&quot;Sending multiple requests and reading their responses (reactive)&quot;</a>.  </p>
<hr />
<p>[<i class="fa fa-coffee"></i>░░░░░░░░░░░░░░░░░░░░░░<i class="fa fa-beer"></i>] 2 hours | <small>17/11/2017</small></p>

		
	</div>
</div>
<script src="https://dev.hollo.me/js/theme.js"></script>
<script src="https://dev.hollo.me/js/prism.js"></script>
<link rel="stylesheet" href="https://dev.hollo.me/css/prism.css">
</body>
</html>
