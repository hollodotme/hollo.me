<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>Multi language-version builds on Circle CI | Holger Woltersdorf&#039;s blog</title>
	<meta name="description" content="How to configure a kind of build matrix on Circle CI - CAUTION: YAML!">
	<meta name="keywords" content="PHP, Continuous Integration, Docker, Yaml, Versions, Build matrix, Build jobs">
	<meta name="HandheldFriendly" content="True"/>
	<meta name="geo.region" content="DE-SN"/>
	<meta name="geo.placename" content="Dresden"/>
	<meta name="geo.position" content="51.052088;13.741672"/>
	<meta name="ICBM" content="51.052088, 13.741672"/>
	<meta name="twitter:site" content="@hollodotme">
	<meta name="twitter:creator" content="@hollodotme">
	<script type="application/ld+json">{
  "@context" : "http://schema.org",
  "@type": "Person",
  "name": "Holger Woltersdorf&#039;s blog",
  "image": "http://127.0.0.1:8080/img/posts/icehawk-ci-build.png",
  "url": "http://127.0.0.1:8080",
  "sameAs" : [
      "https://twitter.com/hollodotme",
      "https://www.xing.com/profile/Holger_Woltersdorf"
    ]
  }
}</script>
	<meta property="article:author" content="https://www.xing.com/profile/Holger_Woltersdorf"/>
	<meta property="article:publisher" content="https://www.xing.com/profile/Holger_Woltersdorf"/>
	<link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
	<link rel="manifest" href="/favicon/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">

	<link rel="canonical" href="http://127.0.0.1:8080/php/multi-language-version-builds-on-circle-ci.html"/>
	<meta name="referrer" content="origin"/>

	<meta property="og:site_name" content="Holger Woltersdorf&#039;s blog"/>
	<meta property="og:type" content="article"/>
	<meta property="og:title" content="Multi language-version builds on Circle CI | Holger Woltersdorf&#039;s blog"/>
	<meta property="og:description" content="How to configure a kind of build matrix on Circle CI - CAUTION: YAML!"/>
	<meta property="og:url" content="http://127.0.0.1:8080"/>
	<meta property="og:image" content="http://127.0.0.1:8080/img/posts/icehawk-ci-build.png"/>
	<meta property="article:published_time" content="2018-12-28T16:04:28+00:00"/>
	<meta property="article:modified_time" content="2018-12-28T16:04:28+00:00"/>
			<meta property="article:tag" content="PHP"/>
			<meta property="article:tag" content="Continuous Integration"/>
			<meta property="article:tag" content="Docker"/>
			<meta property="article:tag" content="Yaml"/>
			<meta property="article:tag" content="Versions"/>
			<meta property="article:tag" content="Build matrix"/>
			<meta property="article:tag" content="Build jobs"/>
		<meta name="twitter:card" content="summary_large_image"/>
	<meta name="twitter:title" content="Multi language-version builds on Circle CI | Holger Woltersdorf&#039;s blog"/>
	<meta name="twitter:description" content="How to configure a kind of build matrix on Circle CI - CAUTION: YAML!"/>
	<meta name="twitter:url" content="http://127.0.0.1:8080/php/multi-language-version-builds-on-circle-ci.html"/>
	<meta name="twitter:image:src" content="http://127.0.0.1:8080/img/posts/icehawk-ci-build.png"/>

	<meta name="generator" content="IceHawk Static Page Generator"/>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<link href="https://fonts.googleapis.com/css?family=Oxygen|Oxygen+Mono" rel="stylesheet">
	<link rel="stylesheet" type="text/css" media="screen" href="http://127.0.0.1:8080/css/theme.css">
	<script src="https://use.fontawesome.com/3513f09ab7.js"></script>
	</head>
<body>
<div class="themewrapper">

	<a href="#" id="sidebar-toggle"><i class="fa fa-close genericon"></i></a>

	<div id="sidebar">
		<div class="brand-well">
			<a href="http://127.0.0.1:8080">
				<img src="http://127.0.0.1:8080/img/hwoltersdorf_blue_500x500.png" alt="Holger Woltersdorf">
			</a>
		</div>

		<h3 class="text-center text-uppercase">Holger Woltersdorf</h3>
		<p class="text-center text-uppercase subline">
			CIO &middot; Developer &middot; Speaker<br>
			PHP &middot; WEB &middot; Community
		</p>

		<hr>

		<ul class="sociallinks">
			<li>
				<a href="https://twitter.com/hollodotme" title="Holger Woltersdorf on twitter (@hollodotme)" target="_blank"><i class="fa fa-twitter"></i></a>
			</li>
			<li>
				<a href="https://www.xing.com/profile/Holger_Woltersdorf" title="Holger Woltersdorf on Xing" target="_blank"><i class="fa fa-xing"></i></a>
			</li>
			<li>
				<a href="https://github.com/hollodotme" title="Holger Woltersdorf on GitHub" target="_blank"><i class="fa fa-github"></i></a>
			</li>
			<li>
				<a href="https://www.linkedin.com/in/holgerwoltersdorf" title="Holger Woltersdorf on LinkedIn" target="_blank"><i class="fa fa-linkedin"></i></a>
			</li>
		</ul>

		<hr>

		<ul class="sidebar-nav">
			<li class="hidden-sm hidden-md hidden-lg">
				<a href="http://127.0.0.1:8080/" title="Home">Home</a>
			</li>
			
						<li class="active">
		<a href="http://127.0.0.1:8080/php.html">PHP</a>
			</li>


			
						<li>
		<a href="http://127.0.0.1:8080/talks.html">Talks</a>
			</li>


			
						<li>
		<a href="http://127.0.0.1:8080/projects.html">Projects</a>
			</li>


			
						<li>
		<a href="http://127.0.0.1:8080/devops.html">DevOps</a>
			</li>


			
						<li>
		<a href="http://127.0.0.1:8080/reading-list.html">Reading list</a>
			</li>


			
						<li>
		<a href="http://127.0.0.1:8080/imprint.html">Imprint</a>
			</li>


						<li>
				<a href="https://www.papercall.io/speakers/hollodotme" target="_blank" title="My profile on papercall.io">
					PaperCall.io profile
				</a>
			</li>
			<li>
				<a href="https://speakerdeck.com/hollodotme" target="_blank" title="My profile on speakerdeck.com">
					SpeakerDeck profile
				</a>
			</li>
		</ul>

		<hr>

		<div class="text-center">
			<p>
				<small>Co-Founder of</small>
			</p>
			<a href="http://phpug-dresden.org" target="_blank">
				<img src="http://127.0.0.1:8080/img/php-usergroup-dresden.png" alt="PHP USERGROUP DRESDEN e.V." class="img img-50">
			</a>
		</div>

		<hr>

		<p class="text-center">
			<strong>Found a bug or a typo?</strong><br>
			This website is open source,<br>
			<a href="https://github.com/hollodotme/hollo.me" target="_blank" title="Website GitHub repository">please fork it and provide a PR</a>.
		</p>
		<p class="text-center website-version">
			<small>v1.2.1</small>
		</p>

	</div>

	<div id="breadcrumbs">
		<ul>
												<li>
						<a href="http://127.0.0.1:8080/index.html">
							<i class="fa fa-map-marker"></i> Home
						</a>
					</li>
																<li>
						<a href="http://127.0.0.1:8080/php.html">
							 PHP
						</a>
					</li>
																<li class="active">
						 Multi language-version builds on Circle CI
					</li>
									</ul>
	</div>

	<div id="main">

		
			<h1>Multi language-version builds on Circle CI</h1>
			<h5>How to configure a kind of build matrix on Circle CI - CAUTION: YAML!</h5>
			<hr>

			<p>Unlike <a href="https://travic-ci.org">travis-ci.org</a>, <a href="https://circleci.com">Circle CI</a> does not support build matrices.
This post will show you how to set up an extensible workflow for multi PHP version builds.</p>
<p>I started working on a new version of the <a href="https://icehawk.github.io">IceHawk framework</a> and want to support the two current
versions of PHP: 7.2 and 7.3. Until now all builds for the framework were processed on travis-ci, but as I use Circle CI at the job
I wanted to switch over, so I can reuse some existing build templates. Circle CI offers free builds for open source projects with up to 4
parallel containers. (In a paid plan you have to pay $150/month for the same parallelism.)  </p>
<hr />
<h2>Build jobs</h2>
<p>In this project I defined the following jobs for each PHP version:</p>
<ul>
<li>Build the docker image and push it to <a href="https://hub.docker.com">hub.docker.com</a></li>
<li>Checkout the code and install the dependencies via <a href="https://getcomposer.org">composer</a></li>
<li>Run PHP linting on the source code (<code>php -l</code>)</li>
<li>Run a static code analysis using <a href="https://phpstan.org">PHPStan</a></li>
<li>Run the unit tests using <a href="https://phpunit.de">PHPUnit</a> and upload code coverage to <a href="https://codecov.io">codecov.io</a></li>
<li>Run the integration tests using <a href="https://phpunit.de">PHPUnit</a></li>
<li>Create some code metrics using <a href="https://www.phpmetrics.org">PhpMetrics</a></li>
<li>Auto-create a github release, if a git tag is present on branch master using <a href="https://github.com/tcnksm/ghr">ghr</a></li>
</ul>
<hr />
<h2>Workflow</h2>
<p>In the end, the whole workflow looks like this.
<a href="http://127.0.0.1:8080/img/posts/icehawk-ci-build.png"><img src="http://127.0.0.1:8080/img/posts/icehawk-ci-build.png" alt="IceHawk CI build workflow" /></a></p>
<hr />
<h2>Step by Step</h2>
<h3>Contexts and environment variables</h3>
<p>Circle CI has a feature called &quot;contexts&quot;, which is a set of custom environment variables. You can require a context
for your jobs in your workflow definition. In order to make things version specific, I added two contexts to the Circle CI
organization. Both contain just a single variable:</p>
<p><strong>Context &gt; php72</strong></p>
<pre><code class="language-bash">PHP_VERSION="7.2"</code></pre>
<p><strong>Context &gt; php73</strong></p>
<pre><code class="language-bash">PHP_VERSION="7.3"</code></pre>
<p>All environment variables that are version independent like docker hub credentials, github oauth token and codecov token
are set up as simple environment variables in the Circle CI project settings.</p>
<p>Those environment variables must not be required explicitly, they will be available in every build job automatically.</p>
<h3>Working directories</h3>
<p>Circle CI workflows share <em>ONE</em> storage known as &quot;workspace&quot;, which can be attached to every build job in order to
use files/results from previous jobs. And there lies a problem. When running e.g. <code>composer install</code> on different
versions of PHP it can install different versions of packages, depending on their platform requirements. So using a
single checkout/install directory may cause problems on subsequent build jobs.</p>
<p>And there is another problem to the <code>working_directory</code> directive in Circle CI. It does not expand environment variables.
So it is not possible to use the previously set environment variable <code>$PHP_VERSION</code> in the path value of <code>working_directory</code>.</p>
<p>Long story short, in order to have separate installation directories for each PHP version, I created aliases for each
directory which will be injected into the jobs accordingly.</p>
<pre><code class="language-yaml">workdir-72: &amp;workdir-72
  working_directory: ~/repo/7.2

workdir-73: &amp;workdir-73
  working_directory: ~/repo/7.3</code></pre>
<h3>Step definitions</h3>
<p>In most cases the step definitions / commands will be identical for all PHP versions,
so we can also create aliases for them. I prefix them with &quot;shared-&quot;, so it's clear that they are used multiple times.</p>
<p>The first job is to build and push the PHP docker images that will be used in nearly all subsequent jobs.</p>
<p>The Dockerfile and further build configs for each PHP version are located in the repository at <code>.docker/php/&lt;PHP_VERSION&gt;/Dockerfile</code>.</p>
<pre><code class="language-yaml">shared-build: &amp;shared-build
  working_directory: ~/repo
  machine:
    docker_layer_caching: true
  steps:
    - checkout
    - run:
        name: Build docker image
        command: &gt;
          docker build 
          -t "$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$PHP_VERSION-cli" 
          -f .docker/php/$PHP_VERSION/Dockerfile 
          .docker/php/$PHP_VERSION
    - run:
        name: Login to hub.docker.com
        command: |
          echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USER --password-stdin
    - run:
        name: Push docker image
        command: |
          docker push "$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$PHP_VERSION-cli"</code></pre>
<p>This job is a bit special, because:</p>
<ul>
<li>It doesn't use the separated working directories.</li>
<li>It uses a real virtual machine at Circle CI to run the docker commands.</li>
</ul>
<p>As you can see various environment variables are used in these steps:</p>
<ul>
<li><code>$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME</code> is the project's slug at GitHub and those are provided by Circle CI by default</li>
<li><code>$PHP_VERSION</code> from the required context</li>
<li><code>$DOCKER_HUB_USER</code> &amp; <code>$DOCKER_HUB_PASSWORD</code> from the project's environment variables</li>
</ul>
<p>The next job alias will checkout the code, do the <code>composer install</code> and persist the project to the workspace.</p>
<pre><code class="language-yaml">shared-code: &amp;shared-code
  docker:
    - image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$PHP_VERSION-cli
  steps:
    - checkout

    # Download and cache dependencies
    - restore_cache:
        keys:
          - v1-dependencies-{{ checksum "composer.json" }}-$PHP_VERSION

    - run:
        name: Update composer
        command: composer self-update

    - run:
        name: Install dependencies
        command: |
          composer install -o --prefer-dist --no-interaction

    - save_cache:
        paths:
          - ./vendor
        key: v1-dependencies-{{ checksum "composer.json" }}-$PHP_VERSION

    - run:
        name: Prepare log directories
        command: |
          mkdir -p build/logs/coverage
          mkdir -p build/logs/junit
          mkdir -p build/logs/phpmetrics

    - persist_to_workspace:
        root: ~/repo
        paths:
          - "*"</code></pre>
<p><strong>Please note:</strong> As this job has different working directories for each context, I persist everything under <code>~/repo</code>
to the shared workspace. Everything means exactly two directories <code>~/repo/7.2</code> &amp; <code>~/repo/7.3</code>. The paths listing also is not
able to expand environment variables, so it's sadly not possible to use <code>- $PHP_VERSION</code> here.  </p>
<p>All the following aliases all work the same way. They just have different steps/commands.</p>
<h3>Job definitions</h3>
<p>The next config section defines the actual jobs that shall be available for the workflow.</p>
<p>Basically you create job names and inject the appropriate aliases.</p>
<pre><code class="language-yaml">jobs:
  "php-7.2-build":
    &lt;&lt;: *shared-build

  "php-7.3-build":
    &lt;&lt;: *shared-build

  "php-7.2-code":
    &lt;&lt;: *shared-code
    &lt;&lt;: *workdir-72

  "php-7.3-code":
    &lt;&lt;: *shared-code
    &lt;&lt;: *workdir-73

  "php-7.2-linting":
    &lt;&lt;: *shared-linting
    &lt;&lt;: *workdir-72

  "php-7.3-linting":
    &lt;&lt;: *shared-linting
    &lt;&lt;: *workdir-73

  "php-7.2-unit-tests":
    &lt;&lt;: *shared-unit-tests
    &lt;&lt;: *workdir-72

  "php-7.3-unit-tests":
    &lt;&lt;: *shared-unit-tests
    &lt;&lt;: *workdir-73

  "php-7.2-integration-tests":
    &lt;&lt;: *shared-integration-tests
    &lt;&lt;: *workdir-72

  "php-7.3-integration-tests":
    &lt;&lt;: *shared-integration-tests
    &lt;&lt;: *workdir-73

  "php-7.2-phpstan":
    &lt;&lt;: *shared-phpstan
    &lt;&lt;: *workdir-72

  "php-7.3-phpstan":
    &lt;&lt;: *shared-phpstan
    &lt;&lt;: *workdir-73

  "php-7.2-phpmetrics":
    &lt;&lt;: *shared-phpmetrics
    &lt;&lt;: *workdir-72

  "php-7.3-phpmetrics":
    &lt;&lt;: *shared-phpmetrics
    &lt;&lt;: *workdir-73

  "php-7.2-github-release":
    &lt;&lt;: *shared-github-release
    &lt;&lt;: *workdir-72

  "php-7.3-github-release":
    &lt;&lt;: *shared-github-release
    &lt;&lt;: *workdir-73</code></pre>
<h3>Workflow definition</h3>
<p>The last config section describes the workflow and the dependencies of jobs. As you can see I created two parallel
pipelines, one for each PHP version with jobs requiring the right version context.</p>
<pre><code class="language-yaml">workflows:
  version: 2
  build-test-analyze:
    jobs:

      # PHP 7.2 jobs

      - "php-7.2-build":
          context: php72
      - "php-7.2-code":
          context: php72
          requires:
            - "php-7.2-build"
      - "php-7.2-linting":
          context: php72
          requires:
            - "php-7.2-code"
      - "php-7.2-phpstan":
          context: php72
          requires:
            - "php-7.2-code"
      - "php-7.2-unit-tests":
          context: php72
          requires:
            - "php-7.2-linting"
            - "php-7.2-phpstan"
      - "php-7.2-integration-tests":
          context: php72
          requires:
            - "php-7.2-linting"
            - "php-7.2-phpstan"
      - "php-7.2-phpmetrics":
          context: php72
          requires:
            - "php-7.2-unit-tests"
            - "php-7.2-integration-tests"
      - "php-7.2-github-release":
          context: php72
          requires:
            - "php-7.2-phpmetrics"
          filters:
            branches:
              only: master

      # PHP 7.3 jobs

      - "php-7.3-build":
          context: php73
      - "php-7.3-code":
          context: php73
          requires:
            - "php-7.3-build"
      - "php-7.3-linting":
          context: php73
          requires:
            - "php-7.3-code"
      - "php-7.3-phpstan":
          context: php73
          requires:
            - "php-7.3-code"
      - "php-7.3-unit-tests":
          context: php73
          requires:
            - "php-7.3-linting"
            - "php-7.3-phpstan"
      - "php-7.3-integration-tests":
          context: php73
          requires:
            - "php-7.3-linting"
            - "php-7.3-phpstan"
      - "php-7.3-phpmetrics":
          context: php73
          requires:
            - "php-7.3-unit-tests"
            - "php-7.3-integration-tests"
      - "php-7.3-github-release":
          context: php73
          requires:
            - "php-7.3-phpmetrics"
          filters:
            branches:
              only: master</code></pre>
<p><strong>Please note:</strong> The last job is only visible and executed on branch master.</p>
<hr />
<h2>Putting it all together</h2>
<pre><code class="language-yaml">version: 2

# Specify working directories for each PHP version
# Unfortunately Circle CI is not able to expand environment/context variables in
# the value for working_directory
workdir-72: &amp;workdir-72
  working_directory: ~/repo/7.2

workdir-73: &amp;workdir-73
  working_directory: ~/repo/7.3

# Define steps to build docker images for each PHP version
shared-build: &amp;shared-build
  working_directory: ~/repo
  machine:
    docker_layer_caching: true
  steps:
    - checkout
    - run:
        name: Build docker image
        command: &gt;
          docker build 
          -t "$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$PHP_VERSION-cli" 
          -f .docker/php/$PHP_VERSION/Dockerfile 
          .docker/php/$PHP_VERSION
    - run:
        name: Login to hub.docker.com
        command: |
          echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USER --password-stdin
    - run:
        name: Push docker image
        command: |
          docker push "$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$PHP_VERSION-cli"

# Define steps to build the code and its dependencies
# Persist it to the workspace when done
shared-code: &amp;shared-code
  docker:
    - image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$PHP_VERSION-cli
  steps:
    - checkout

    # Download and cache dependencies
    - restore_cache:
        keys:
          - v1-dependencies-{{ checksum "composer.json" }}-$PHP_VERSION

    - run:
        name: Update composer
        command: composer self-update

    - run:
        name: Install dependencies
        command: |
          composer install -o --prefer-dist --no-interaction

    - save_cache:
        paths:
          - ./vendor
        key: v1-dependencies-{{ checksum "composer.json" }}-$PHP_VERSION

    - run:
        name: Prepare log directories
        command: |
          mkdir -p build/logs/coverage
          mkdir -p build/logs/junit
          mkdir -p build/logs/phpmetrics

    - persist_to_workspace:
        root: ~/repo
        paths:
          - "*"

# Define steps to check for PHP parse errors
shared-linting: &amp;shared-linting
  docker:
    - image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$PHP_VERSION-cli
  steps:
    - attach_workspace:
        at: ~/repo

    - run:
        name: Check for PHP parse errors
        command: find ./src -type f -name '*.php' -print0 | xargs -0 -n1 -P4 php -l -n | (! grep -v "No syntax errors detected" )

# Define steps to run unit tests
shared-unit-tests: &amp;shared-unit-tests
  docker:
    - image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$PHP_VERSION-cli
  steps:
    - attach_workspace:
        at: ~/repo

    - run:
        name: Run unit tests
        command: vendor/bin/phpunit.phar -c build --testsuite Unit --log-junit build/logs/junit/junit.xml --coverage-html build/logs/coverage --coverage-clover=coverage.xml

    - run:
        name: Upload code coverage to codecov.io
        command: bash &lt;(curl -s https://codecov.io/bash)

    - store_test_results:
        path: build/logs/junit

    - store_artifacts:
        path: build/logs/junit
        destination: code-coverage-junit

    - store_artifacts:
        path: build/logs/coverage
        destination: code-coverage-html

# Define steps to run integration tests
shared-integration-tests: &amp;shared-integration-tests
  docker:
    - image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$PHP_VERSION-cli
  steps:
    - attach_workspace:
        at: ~/repo

    - run:
        name: Run integration tests
        command: vendor/bin/phpunit.phar -c build --testsuite Integration --log-junit build/logs/junit/junit.xml

    - store_test_results:
        path: build/logs/junit

    - store_artifacts:
        path: build/logs/junit
        destination: code-coverage-junit

# Define steps to run phpmetrics
shared-phpmetrics: &amp;shared-phpmetrics
  docker:
    - image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$PHP_VERSION-cli
  steps:
    - attach_workspace:
        at: ~/repo

    - run:
        name: Run PHP metrics
        command: vendor/bin/phpmetrics.phar --report-html=build/logs/phpmetrics src/

    - store_artifacts:
        path: build/logs/phpmetrics
        destination: php-metrics-report

# Define steps to run phpstan
shared-phpstan: &amp;shared-phpstan
  docker:
    - image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$PHP_VERSION-cli
  steps:
    - attach_workspace:
        at: ~/repo

    - run:
        name: Run PHPStan
        command: vendor/bin/phpstan.phar analyze --level max src/

# Define steps to auto-create a github release, if a tag is present
shared-github-release: &amp;shared-github-release
  docker:
    - image: cibuilds/github
  steps:
    - attach_workspace:
        at: ~/repo
    - run:
        name: Display git tag file
        command: |
          VERSION=$(cat ./TAG)
          echo ${VERSION}
    - run:
        name: Create release at GitHub
        command: VERSION=$(cat ./TAG) &amp;&amp;
          if [[ $VERSION =~ ^v.*$ ]] ;
          then
          ghr -t ${GITHUB_OAUTH_TOKEN}
          -u $CIRCLE_PROJECT_USERNAME
          -r $CIRCLE_PROJECT_REPONAME
          -c ${CIRCLE_SHA1}
          -b "See [CHANGELOG](https://github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/blob/${VERSION}/CHANGELOG.md)"
          -delete ${VERSION} ./docs;
          else
          echo "No version found - no release triggered";
          fi

# Define the actual jobs from the templates above
jobs:
  "php-7.2-build":
    &lt;&lt;: *shared-build

  "php-7.3-build":
    &lt;&lt;: *shared-build

  "php-7.2-code":
    &lt;&lt;: *shared-code
    &lt;&lt;: *workdir-72

  "php-7.3-code":
    &lt;&lt;: *shared-code
    &lt;&lt;: *workdir-73

  "php-7.2-linting":
    &lt;&lt;: *shared-linting
    &lt;&lt;: *workdir-72

  "php-7.3-linting":
    &lt;&lt;: *shared-linting
    &lt;&lt;: *workdir-73

  "php-7.2-unit-tests":
    &lt;&lt;: *shared-unit-tests
    &lt;&lt;: *workdir-72

  "php-7.3-unit-tests":
    &lt;&lt;: *shared-unit-tests
    &lt;&lt;: *workdir-73

  "php-7.2-integration-tests":
    &lt;&lt;: *shared-integration-tests
    &lt;&lt;: *workdir-72

  "php-7.3-integration-tests":
    &lt;&lt;: *shared-integration-tests
    &lt;&lt;: *workdir-73

  "php-7.2-phpstan":
    &lt;&lt;: *shared-phpstan
    &lt;&lt;: *workdir-72

  "php-7.3-phpstan":
    &lt;&lt;: *shared-phpstan
    &lt;&lt;: *workdir-73

  "php-7.2-phpmetrics":
    &lt;&lt;: *shared-phpmetrics
    &lt;&lt;: *workdir-72

  "php-7.3-phpmetrics":
    &lt;&lt;: *shared-phpmetrics
    &lt;&lt;: *workdir-73

  "php-7.2-github-release":
    &lt;&lt;: *shared-github-release
    &lt;&lt;: *workdir-72

  "php-7.3-github-release":
    &lt;&lt;: *shared-github-release
    &lt;&lt;: *workdir-73

# Define the workflows for each PHP version
workflows:
  version: 2
  build-test-analyze:
    jobs:

      # PHP 7.2 jobs

      - "php-7.2-build":
          context: php72
      - "php-7.2-code":
          context: php72
          requires:
            - "php-7.2-build"
      - "php-7.2-linting":
          context: php72
          requires:
            - "php-7.2-code"
      - "php-7.2-phpstan":
          context: php72
          requires:
            - "php-7.2-code"
      - "php-7.2-unit-tests":
          context: php72
          requires:
            - "php-7.2-linting"
            - "php-7.2-phpstan"
      - "php-7.2-integration-tests":
          context: php72
          requires:
            - "php-7.2-linting"
            - "php-7.2-phpstan"
      - "php-7.2-phpmetrics":
          context: php72
          requires:
            - "php-7.2-unit-tests"
            - "php-7.2-integration-tests"
      - "php-7.2-github-release":
          context: php72
          requires:
            - "php-7.2-phpmetrics"
          filters:
            branches:
              only: master

      # PHP 7.3 jobs

      - "php-7.3-build":
          context: php73
      - "php-7.3-code":
          context: php73
          requires:
            - "php-7.3-build"
      - "php-7.3-linting":
          context: php73
          requires:
            - "php-7.3-code"
      - "php-7.3-phpstan":
          context: php73
          requires:
            - "php-7.3-code"
      - "php-7.3-unit-tests":
          context: php73
          requires:
            - "php-7.3-linting"
            - "php-7.3-phpstan"
      - "php-7.3-integration-tests":
          context: php73
          requires:
            - "php-7.3-linting"
            - "php-7.3-phpstan"
      - "php-7.3-phpmetrics":
          context: php73
          requires:
            - "php-7.3-unit-tests"
            - "php-7.3-integration-tests"
      - "php-7.3-github-release":
          context: php73
          requires:
            - "php-7.3-phpmetrics"
          filters:
            branches:
              only: master</code></pre>
<hr />
<h2>Conclusion</h2>
<p>Creating a build matrix on Circle CI for multiple language versions still comes with a lot of config duplication and is messy to read,
but it's doable and can be extended with further versions.</p>
<p>Having one particular job for each version can also be a benefit when it comes to differences in commands or options for
that version as you don't have to add conditionals. Instead you can write a different alias and inject it or simply replace
the step definition alias with actual steps for that particular job.</p>
<hr />
<p><small>12/28/2018</small></p>

		
	</div>
</div>
<script src="http://127.0.0.1:8080/js/theme.js"></script>
<script src="http://127.0.0.1:8080/js/prism.js"></script>
<link rel="stylesheet" href="http://127.0.0.1:8080/css/prism.css">
</body>
</html>
