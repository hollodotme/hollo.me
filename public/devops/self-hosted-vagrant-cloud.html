<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>Self-hosted &#039;vagrant cloud&#039; | Holger Woltersdorf&#039;s blog</title>
	<meta name="description" content="A tutorial on how to set up a self-hosted &#039;vagrant cloud&#039; with versioned, self-packaged vagrant boxes">
	<meta name="keywords" content="">
	<meta name="HandheldFriendly" content="True"/>
	<meta name="geo.region" content="DE-SN"/>
	<meta name="geo.placename" content="Dresden"/>
	<meta name="geo.position" content="51.052088;13.741672"/>
	<meta name="ICBM" content="51.052088, 13.741672"/>
	<meta name="twitter:site" content="@hollodotme">
	<meta name="twitter:creator" content="@hollodotme">
	<script type="application/ld+json">{
  "@context" : "http://schema.org",
  "@type": "Person",
  "name": "Holger Woltersdorf&#039;s blog",
  "image": "https://dev.hollo.me/img/Profile.png",
  "url": "https://dev.hollo.me",
  "sameAs" : [
      "https://twitter.com/hollodotme",
      "https://www.xing.com/profile/Holger_Woltersdorf"
    ]
  }
}</script>
	<meta property="article:author" content="https://www.xing.com/profile/Holger_Woltersdorf"/>
	<meta property="article:publisher" content="https://www.xing.com/profile/Holger_Woltersdorf"/>
	<link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
	<link rel="manifest" href="/favicon/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">

	<link rel="canonical" href="https://dev.hollo.me/devops/self-hosted-vagrant-cloud.html"/>
	<meta name="referrer" content="origin"/>

	<meta property="og:site_name" content="Holger Woltersdorf&#039;s blog"/>
	<meta property="og:type" content="article"/>
	<meta property="og:title" content="Self-hosted &#039;vagrant cloud&#039; | Holger Woltersdorf&#039;s blog"/>
	<meta property="og:description" content="A tutorial on how to set up a self-hosted &#039;vagrant cloud&#039; with versioned, self-packaged vagrant boxes"/>
	<meta property="og:url" content="https://dev.hollo.me"/>
	<meta property="og:image" content="https://dev.hollo.me/img/Profile.png"/>
	<meta property="article:published_time" content="2019-09-02T15:19:55+00:00"/>
	<meta property="article:modified_time" content="2019-09-02T15:19:55+00:00"/>
		<meta name="twitter:card" content="summary_large_image"/>
	<meta name="twitter:title" content="Self-hosted &#039;vagrant cloud&#039; | Holger Woltersdorf&#039;s blog"/>
	<meta name="twitter:description" content="A tutorial on how to set up a self-hosted &#039;vagrant cloud&#039; with versioned, self-packaged vagrant boxes"/>
	<meta name="twitter:url" content="https://dev.hollo.me/devops/self-hosted-vagrant-cloud.html"/>
	<meta name="twitter:image:src" content="https://dev.hollo.me/img/Profile.png"/>

	<meta name="generator" content="IceHawk Static Page Generator"/>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<link href="https://fonts.googleapis.com/css?family=Oxygen|Oxygen+Mono" rel="stylesheet">
	<link rel="stylesheet" type="text/css" media="screen" href="https://dev.hollo.me/css/theme.css">
	<script src="https://use.fontawesome.com/3513f09ab7.js"></script>
	</head>
<body>
<div class="themewrapper">

	<a href="#" id="sidebar-toggle"><i class="fa fa-close genericon"></i></a>

	<div id="sidebar">
		<div class="brand-well">
			<a href="https://dev.hollo.me">
				<img src="https://dev.hollo.me/img/hwoltersdorf_blue_500x500.png" alt="Holger Woltersdorf">
			</a>
		</div>

		<h3 class="text-center text-uppercase">Holger Woltersdorf</h3>
		<p class="text-center text-uppercase subline">
			CIO &middot; Developer &middot; Speaker<br>
			PHP &middot; WEB &middot; Community
		</p>

		<hr>

		<ul class="sociallinks">
			<li>
				<a href="https://twitter.com/hollodotme" title="Holger Woltersdorf on twitter (@hollodotme)" target="_blank"><i class="fa fa-twitter"></i></a>
			</li>
			<li>
				<a href="https://www.xing.com/profile/Holger_Woltersdorf" title="Holger Woltersdorf on Xing" target="_blank"><i class="fa fa-xing"></i></a>
			</li>
			<li>
				<a href="https://github.com/hollodotme" title="Holger Woltersdorf on GitHub" target="_blank"><i class="fa fa-github"></i></a>
			</li>
			<li>
				<a href="https://www.linkedin.com/in/holgerwoltersdorf" title="Holger Woltersdorf on LinkedIn" target="_blank"><i class="fa fa-linkedin"></i></a>
			</li>
		</ul>

		<hr>

		<ul class="sidebar-nav">
			<li class="hidden-sm hidden-md hidden-lg">
				<a href="https://dev.hollo.me/" title="Home">Home</a>
			</li>
			
						<li>
		<a href="https://dev.hollo.me/php.html">PHP</a>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/talks.html">Talks</a>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/projects.html">Projects</a>
			</li>


			
						<li class="active">
		<a href="https://dev.hollo.me/devops.html">DevOps</a>
					<ul class="nav">
															<li>
		<a href="https://dev.hollo.me/devops/routing-to-multiple-docker-compose-development-setups-with-traefik.html">Multi development setup routing</a>
			</li>

											<li class="active">
		<a href="https://dev.hollo.me/devops/self-hosted-vagrant-cloud.html">Self-hosted &#039;vagrant cloud&#039;</a>
			</li>

											<li>
		<a href="https://dev.hollo.me/devops/install-xmpp-server-prosody.html">Install XMPP server prosody</a>
			</li>

							</ul>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/reading-list.html">Reading list</a>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/imprint.html">Imprint</a>
			</li>


						<li>
				<a href="https://www.papercall.io/speakers/hollodotme" target="_blank" title="My profile on papercall.io">
					PaperCall.io profile
				</a>
			</li>
			<li>
				<a href="https://speakerdeck.com/hollodotme" target="_blank" title="My profile on speakerdeck.com">
					SpeakerDeck profile
				</a>
			</li>
		</ul>

		<hr>

		<div class="text-center">
			<p>
				<small>Co-Founder of</small>
			</p>
			<a href="http://phpug-dresden.org" target="_blank">
				<img src="https://dev.hollo.me/img/php-usergroup-dresden.png" alt="PHP USERGROUP DRESDEN e.V." class="img img-50">
			</a>
		</div>

		<hr>

		<p class="text-center">
			<strong>Found a bug or a typo?</strong><br>
			This website is open source,<br>
			<a href="https://github.com/hollodotme/hollo.me" target="_blank" title="Website GitHub repository">please fork it and provide a PR</a>.
		</p>
		<p class="text-center website-version">
			<small>v1.2.1</small>
		</p>

	</div>

	<div id="breadcrumbs">
		<ul>
												<li>
						<a href="https://dev.hollo.me/index.html">
							<i class="fa fa-map-marker"></i> Home
						</a>
					</li>
																<li>
						<a href="https://dev.hollo.me/devops.html">
							 DevOps
						</a>
					</li>
																<li class="active">
						 Self-hosted &#039;vagrant cloud&#039;
					</li>
									</ul>
	</div>

	<div id="main">

		
			<h1>Self-hosted &#039;vagrant cloud&#039;</h1>
			<h5>A tutorial on how to set up a self-hosted 'vagrant cloud' with versioned, self-packaged vagrant boxes</h5>
			<hr>

			<h2>Preamble</h2>
<p>Before we start setting things up, I assume this is what you know / what you have:</p>
<ul>
<li>What vagrant is and how it basically works (obviously!)</li>
<li>How to set up a webserver like nginx or apache2</li>
<li>Basic knowledge about working with linux systems</li>
<li>A public or private webserver where you can run/configure a webserver (nginx/apache2) and upload/download files.</li>
<li>A host system with a GUI (e.g. Windows, Mac OS X, etc.)</li>
</ul>
<p>The tutorial uses an installation of <a href="https://wiki.ubuntu.com/TrustyTahr/ReleaseNotes">Ubuntu 14.04.2 LTS</a>
as the guest machine, <a href="http://virtualbox.org">VirtualBox</a> at version 5.0.0 as provider
and <a href="http://vagrantup.com">Vagrant</a> at version 1.7.4.</p>
<h2>1. Install the tools</h2>
<ul>
<li>Download and install VirtualBox 5.0.0 at <a href="http://download.virtualbox.org/virtualbox/5.0.0/">http://download.virtualbox.org/virtualbox/5.0.0/</a> (Choose the installer that fits your system)</li>
<li>Download and install Vagrant 1.7.4 at <a href="https://dl.bintray.com/mitchellh/vagrant/">https://dl.bintray.com/mitchellh/vagrant/</a> (Choose the installer that fits your system)</li>
</ul>
<h2>2. Prepare your virtual machine</h2>
<h3>2.1 Import an Ubuntu image to VirtualBox</h3>
<ul>
<li>Download a VirtualBox image of Ubuntu 14.04.2 LTS, e.g. at <a href="http://virtualboxes.org/images/ubuntu-server/">http://virtualboxes.org/images/ubuntu-server/</a> (all the following steps refer to this image)</li>
<li>Open the VirtualBox GUI and choose <code>File &gt; Import appliance ...</code>, select the <code>.ova</code> file you downloaded before.</li>
<li>Change the appliance settings to fit your needs, for now I'll only change the name of the machine from <code>ubuntu-14.04-server-amd64</code> to <code>devops-template</code>.</li>
<li>Important: Make sure to activate <code>Reinitialize the MAC address of all network cards</code> checkbox!</li>
<li>Click <code>Import</code> and you'll have a new virtual machine added to VirtualBox after a few minutes ready to run.</li>
</ul>
<h3>2.2 Setup the virtual machine</h3>
<h4>Before you boot the vm for the first time:</h4>
<ul>
<li>Select the newly imported vm named <code>devops-template</code> in VirtualBox GUI and click <code>Settings</code></li>
<li>Select the tab <code>Network</code></li>
<li>Activate <code>Enable Network Adapter</code> (if not already activated) under the tab <code>Adapter 1</code></li>
<li>Select <code>Attached to:</code> <code>NAT</code> (<a href="http://docs.vagrantup.com/v2/virtualbox/boxes.html">this is a requirement by Vagrant</a>)</li>
<li>Leave everything else as is.</li>
</ul>
<h4>Configure the guest</h4>
<ul>
<li>Select the vm named <code>devops-template</code> in VirtualBox GUI and click <code>Start</code> (wait until you see the <code>ubuntu-amd64 login:</code>) </li>
<li>Type <code>ubuntu</code> as loginname an <code>reverse</code> as password.</li>
<li>First of all, update the machine. This will take a moment. Get a coffee!</li>
</ul>
<pre><code class="language-bash">$ sudo apt-get update
$ sudo apt-get dist-upgrade -y</code></pre>
<ul>
<li>Edit the file <code>/root/.profile</code></li>
</ul>
<pre><code class="language-bash">$ sudo nano /root/.profile
# ~/.profile: executed by Bourne-compatible login shells.

if [ "$BASH" ]; then
  if [ -f ~/.bashrc ]; then
    . ~/.bashrc
  fi
fi

mesg n # replace this line by "tty -s &amp;&amp; mesg n"</code></pre>
<p>Note: This avoids an annoying warning, when you <code>vagrant up</code> later.</p>
<ul>
<li>Change the hostname</li>
</ul>
<pre><code class="language-bash">$ sudo nano /etc/hostname
ubuntu-amd64 # replace this by "devops-template"</code></pre>
<ul>
<li>Let the machine resolve its own hostname</li>
</ul>
<pre><code class="language-bash">$ sudo nano /etc/hosts
127.0.0.1   localhost
127.0.1.1   ubuntu-amd64    # replace this by "127.0.1.1 devops-template"

# The following lines are desirable for IPv6 capable hosts
::1         localhost ip6-localhost ip6-loopback
ff02::1     ip6-allnodes
ff02::2     ip6-allrouters</code></pre>
<ul>
<li>Finalize language settings</li>
</ul>
<pre><code class="language-bash">$ sudo locale-gen en_US.UTF-8 # Or whatever language you want to use
$ sudo dpkg-reconfigure locales
$ sudo nano /etc/default/locale
LANG="en_US.UTF-8"
LANGUAGE="en_US"</code></pre>
<ul>
<li>Add the <code>vagrant</code> user</li>
</ul>
<pre><code class="language-bash">$ sudo adduser vagrant
# Set the password to "vargrant" too!
# Set the Full Name to "Vagrant", leave the rest blank</code></pre>
<ul>
<li>Allow Vagrant to login via insecure private key</li>
</ul>
<pre><code class="language-bash"># Add a ssh config folder and authorized_keys file
$ sudo mkdir /home/vagrant/.ssh
$ sudo touch /home/vagrant/.ssh/authorized_keys
# Set owner and permissions
$ sudo chown -R vagrant /home/vagrant/.ssh
$ sudo chmod 0700 /home/vagrant/.ssh
$ sudo chmod 0600 /home/vagrant/.ssh/authorized_keys
# Add the insecure public key, see https://github.com/mitchellh/vagrant/tree/master/keys
$ su vagrant
$ curl 'https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant.pub' &gt;&gt; /home/vagrant/.ssh/authorized_keys
$ exit</code></pre>
<ul>
<li>Configure the sudo rights of user <code>vagrant</code></li>
</ul>
<pre><code class="language-bash">$ sudo nano /etc/sudoers.d/vagrant
vagrant ALL=(ALL) NOPASSWD: ALL
$ sudo chmod 0440 /etc/sudoers.d/vagrant</code></pre>
<ul>
<li>Disable DNS usage for sshd</li>
</ul>
<pre><code class="language-bash">$ sudo nano /etc/ssh/sshd_config
# Add the following line at the end of the file:
UseDNS no</code></pre>
<ul>
<li><strong>Important:</strong> Install the VirtualBox Guest Additions <strong>with the proper version</strong></li>
</ul>
<p>Hint: Do not install the guest additions with <code>apt-get install virtualbox-guest-additions-iso</code> as this release is mostly outdated.
I said above that I'm using VirtualBox in Version <code>5.0.0</code>, so the guest additions should be of the same version.</p>
<pre><code class="language-bash"># prepare
$ sudo apt-get install -y linux-headers-generic build-essential dkms
# get the right ISO from http://download.virtualbox.org/virtualbox/
$ wget http://download.virtualbox.org/virtualbox/5.0.0/VBoxGuestAdditions_5.0.0.iso
# create a mount folder
$ sudo mkdir /media/VBoxGuestAdditions
# mount the ISO
$ sudo mount -o loop,ro VBoxGuestAdditions_5.0.0.iso /media/VBoxGuestAdditions
# install the guest additions
$ sudo sh /media/VBoxGuestAdditions/VBoxLinuxAdditions.run
# remove the ISO
$ rm VBoxGuestAdditions_5.0.0.iso
# unmount the ISO
$ sudo umount /media/VBoxGuestAdditions
# remove the mount folder
$ sudo rmdir /media/VBoxGuestAdditions</code></pre>
<ul>
<li><strong>Last but not least:</strong> Change the welcome message and add the version number. We will change this later to see versioning work.</li>
</ul>
<pre><code class="language-bash">$ rm -rf /etc/motd
$ sudo nano /etc/motd
--
Welcome to devops-template version 0.1.0!
--</code></pre>
<ul>
<li>Reboot the vm to see your changes take effect:</li>
</ul>
<pre><code class="language-bash">$ sudo shutdown -r now</code></pre>
<p>Now you should see a login terminal like this:</p>
<pre><code class="language-bash">Ubuntu 14.04.2 LTS devops-template tty1

devops-template login: _</code></pre>
<p>Login and check the message of the day (motd) we set up:</p>
<pre><code class="language-bash">Last login: ...
Welcome to Ubuntu ...

 * Documentation: ...

 [...]

--
Welcome to devops-template version 0.1.0!
--
ubuntu@devops-template:~$ _</code></pre>
<ul>
<li>Shutdown the vm</li>
</ul>
<pre><code class="language-bash">$ sudo shutdown -h now</code></pre>
<p>Got it? Yeah, preparation is done!</p>
<h2>3. Package the vagrant box</h2>
<p>Remember, we said in the message of the day, that this is version <code>0.1.0</code>.</p>
<ul>
<li>Open a terminal on your host machine</li>
<li>Create two new directories: <code>VagrantBoxes</code> and <code>VagrantTest</code></li>
</ul>
<pre><code class="language-bash">$ mkdir ~/VagrantBoxes
$ mkdir ~/VagrantTest</code></pre>
<h3>3.1 Create the box out of the vm named <code>devops-template</code> in VirtualBox</h3>
<ul>
<li>Change into the <code>VagrantBoxes</code> directory.</li>
<li>Package the box</li>
</ul>
<pre><code class="language-bash">$ cd ~/VagrantBoxes
$ vagrant package --base 'devops-template' --output 'devops_0.1.0.box'</code></pre>
<p>Note: Because we will build multiple versions of the <code>devops-template</code> vm, we will put the version number in the name of the box file.</p>
<p>Packaging will take some time, you may get your next coffee!</p>
<p>When packaging is done, you should see an output like this:</p>
<pre><code class="language-bash">==&gt; devops-template: Exporting VM...
==&gt; devops-template: Compressing package to: ~/VagrantBoxes/devops_0.1.0.box</code></pre>
<h3>3.2 Test the box</h3>
<ul>
<li>Change into the <code>VagrantTest</code> directory.</li>
</ul>
<pre><code class="language-bash">$ cd ~/VagrantTest</code></pre>
<ul>
<li>Add the box to vagrant</li>
</ul>
<pre><code class="language-bash">$ vagrant box add 'devops' file://~/VagrantBoxes/devops_0.1.0.box</code></pre>
<p>If successful, you should see output like this:</p>
<pre><code class="language-bash">==&gt; box: Adding box 'devops' (v0) for provider:
    box: Downloading: file://~/VagrantBoxes/devops_0.1.0.box
==&gt; box: Successfully added box 'devops' (v0) for 'virtualbox'!</code></pre>
<p>Note the <code>v0</code>. There is no version specified yet. </p>
<ul>
<li>Init a vagrant project</li>
</ul>
<pre><code class="language-bash">$ vagrant init</code></pre>
<p>Now there is a <code>Vagrantfile</code> with default settings in your current directory.</p>
<ul>
<li>Edit this <code>Vagrantfile</code> using a text editor</li>
</ul>
<pre><code class="language-bash"># Change the following line from
config.vm.box = "base"
# to
config.vm.box = "devops"
# save the file</code></pre>
<p>Note: <code>base</code> is vagrant's default name for a box. But we told <code>vagrant box add</code> the name <code>devops</code>.</p>
<ul>
<li>Bring the machine up</li>
</ul>
<pre><code class="language-bash">$ vagrant up</code></pre>
<p>If done, you should see output like this:</p>
<pre><code class="language-bash">Bringing machine 'default' up with 'virtualbox' provider...
==&gt; default: Importing base box 'devops'...
==&gt; default: Matching MAC address for NAT networking...
==&gt; default: Setting the name of the VM: VagrantTest_default_1406634147824_25052
==&gt; default: Clearing any previously set network interfaces...
==&gt; default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
==&gt; default: Forwarding ports...
    default: 22 =&gt; 2222 (adapter 1)
==&gt; default: Booting VM...
==&gt; default: Waiting for machine to boot. This may take a few minutes...
    default: SSH address: 127.0.0.1:2222
    default: SSH username: vagrant
    default: SSH auth method: private key
    default: Warning: Connection timeout. Retrying...
==&gt; default: Machine booted and ready!
==&gt; default: Checking for guest additions in VM...
==&gt; default: Mounting shared folders...
    default: /vagrant =&gt; ~/VagrantTest</code></pre>
<p><strong>Note:</strong> Vagrant's default behaviour is to boot the vm in headless mode (without a GUI in background).
While booting the vm you can see the new vm in your VirtualBox GUI as &quot;-&gt; Running&quot;</p>
<ul>
<li>SSH into the machine</li>
</ul>
<pre><code class="language-bash">$ vagrant ssh</code></pre>
<p>Now you should see our previously added message of the day.</p>
<ul>
<li>Check if your <code>VagrantTest</code> folder is mounted</li>
</ul>
<pre><code class="language-bash">$ cd /vagrant/
$ ls -la</code></pre>
<p>And you should see something like this:</p>
<pre><code class="language-bash">drwxr-xr-x  1 vagrant vagrant  136 Jul 29 13:38 .
drwxr-xr-x 23 root    root    4096 Jul 29 13:42 ..
drwxr-xr-x  1 vagrant vagrant  102 Jul 29 13:38 .vagrant
-rw-r--r--  1 vagrant vagrant 4813 Jul 29 13:39 Vagrantfile</code></pre>
<p><strong>Okay, your box works fine, well done!</strong></p>
<ul>
<li>Exit the SSH session and destroy the machine</li>
</ul>
<pre><code class="language-bash">$ exit # On guest</code></pre>
<pre><code class="language-bash">$ vagrant destroy # On host</code></pre>
<ul>
<li>Remove the box from vagrant (we will add it later with a version again!)</li>
</ul>
<pre><code class="language-bash">$ vagrant box remove 'devops'
Removing box 'devops' (v0) with provider 'virtualbox'...</code></pre>
<h2>4. Using a box catalog for versioning</h2>
<p>In order to serve multiple versions of a vagrant box and enable update notifications we need to set up a box catalog.
This catalog is written in JSON code to a single file.</p>
<p>To keep things simple at this point we will carry on in the local filesystem of your host. </p>
<h3>4.1 Set up the catalog for the <code>devops</code> box</h3>
<ul>
<li>Change into the <code>VagrantBoxes</code> directory.</li>
</ul>
<pre><code class="language-bash">cd ~/VagrantBoxes</code></pre>
<ul>
<li>Create the file <code>devops.json</code> with the following content</li>
</ul>
<pre><code class="language-json">{
    "name": "devops",
    "description": "This box contains Ubuntu 14.04.2 LTS 64-bit.",
    "versions": [{
        "version": "0.1.0",
        "providers": [{
                "name": "virtualbox",
                "url": "file://~/VagrantBoxes/devops_0.1.0.box",
                "checksum_type": "sha1",
                "checksum": "d3597dccfdc6953d0a6eff4a9e1903f44f72ab94"
        }]
    }]
}</code></pre>
<p><strong>What is going on here?</strong></p>
<ul>
<li>We tell the catalog to be related to the box name <code>devops</code>. All versions will be grouped under this name.</li>
<li>We created a clear statement of what is in the box.</li>
<li>We defined the first version 0.1.0</li>
<li>We tell that, version 0.1.0 is available for provider virtualbox under the URL file://~/VagrantBoxes/devops_0.1.0.box 
<ul>
<li>That's why you should put the version into the filename!</li>
</ul></li>
<li>We tell vagrant that there is a sha1-checksum to check when importing the box.
<ul>
<li>To determine the checksum of your box, you can simple do sth. like this:</li>
</ul></li>
</ul>
<pre><code class="language-bash">$ openssl sha1 ~/VagrantBoxes/devops_0.1.0.box
SHA1(~/VagrantBoxes/devops_0.1.0.box)= d3597dccfdc6953d0a6eff4a9e1903f44f72ab94</code></pre>
<p>Note: This is done on a linux based system. On Windows there will be another way.</p>
<p>Your catalog is finished!</p>
<h3>4.2 Link the catalog to vagrant instead of the box</h3>
<ul>
<li>Change into the <code>VagrantTest</code> directory</li>
</ul>
<pre><code class="language-bash">$ cd ~/VagrantTest</code></pre>
<ul>
<li>Edit the <code>Vagrantfile</code> file in a text editor</li>
</ul>
<pre><code class="language-ruby"># Under ...
config.vm.box = "devops"
# ... add the line
config.vm.box_url = "file://~/VagrantBoxes/devops.json"
# save the file</code></pre>
<ul>
<li>Run <code>vagrant up</code> <strong>without</strong> adding the box manually using <code>vagrant box add</code></li>
</ul>
<pre><code class="language-bash">$ vagrant up</code></pre>
<p>When done, you should see output like this:</p>
<pre><code class="language-bash">Bringing machine 'default' up with 'virtualbox' provider...
==&gt; default: Box 'devops' could not be found. Attempting to find and install...
    default: Box Provider: virtualbox
    default: Box Version: &gt;= 0
==&gt; default: Loading metadata for box 'file://~/VagrantBoxes/devops.json'
    default: URL: file://~/VagrantBoxes/devops.json
==&gt; default: Adding box 'devops' (v0.1.0) for provider: virtualbox
    default: Downloading: file://~/VagrantBoxes/devops_0.1.0.box
    default: Calculating and comparing box checksum...
==&gt; default: Successfully added box 'devops' (v0.1.0) for 'virtualbox'!</code></pre>
<p><strong>Note</strong> the line <code>Loading metadata for box 'file://~/VagrantBoxes/devops.json'</code> that confirms the catalog is read.
<strong>And note</strong> the line <code>Adding box 'devops' (v0.1.0) for provider: virtualbox</code> that confirms that version 0.1.0 is added to VirtualBox.
The last two lines confirm that our checksum in the <code>devops.json</code> file was correct.</p>
<pre><code class="language-bash">==&gt; default: Importing base box 'devops'...
==&gt; default: Matching MAC address for NAT networking...
==&gt; default: Checking if box 'devops' is up to date...
==&gt; default: Setting the name of the VM: VagrantTest_default_1406640770074_13210
==&gt; default: Clearing any previously set network interfaces...
==&gt; default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
==&gt; default: Forwarding ports...
    default: 22 =&gt; 2222 (adapter 1)
==&gt; default: Booting VM...
==&gt; default: Waiting for machine to boot. This may take a few minutes...
    default: SSH address: 127.0.0.1:2222
    default: SSH username: vagrant
    default: SSH auth method: private key
    default: Warning: Connection timeout. Retrying...
==&gt; default: Machine booted and ready!
==&gt; default: Checking for guest additions in VM...
==&gt; default: Mounting shared folders...
    default: /vagrant =&gt; ~/VagrantTest</code></pre>
<p>Again, our machine is up and running.
If you wish you now can re-check by ssh into the machine, reading the message of the day and listing the content of <code>/vagrant</code> on the guest. </p>
<p>Okay, now we have built a vagrant box with an initial version. <strong>Let's add another version.</strong></p>
<ul>
<li>Halt the vm (<strong>do not</strong> destroy it!)</li>
</ul>
<pre><code class="language-bash">$ vagrant halt
==&gt; default: Attempting graceful shutdown of VM...</code></pre>
<h3>4.3 Raise the box version by changing the template vm</h3>
<ul>
<li>Open the VirtualBox GUI, select the vm named <code>devops-template</code> and click <code>Start</code></li>
<li>Log into the vm after it has booted</li>
<li>Change the version number in <code>/etc/motd</code> from <code>0.1.0</code> to <code>0.1.1</code> and save the file</li>
</ul>
<pre><code class="language-bash">$ sudo nano /etc/motd
--
Welcome to devops-template version 0.1.1!
--</code></pre>
<ul>
<li>Shutdown the vm</li>
</ul>
<pre><code class="language-bash">$ sudo shutdown -h now</code></pre>
<p><strong>To be clear:</strong> Changing the version number in <code>/etc/motd</code> has nothing to do with the version itself. It just simulates
a minor but visible change to the vm template. Instead of changing the content of a file, you'll be installing software
or editing configs on a real-world vm.</p>
<ul>
<li>Change into <code>VagrantBoxes</code> directory.</li>
</ul>
<pre><code class="language-bash">$ cd ~/VagrantBoxes</code></pre>
<ul>
<li>Package the template vm to a new vagrant box</li>
</ul>
<pre><code class="language-bash">$ vagrant package --base 'devops-template' --output 'devops_0.1.1.box'
==&gt; devops-template: Exporting VM...
==&gt; devops-template: Compressing package to: ~/VagrantBoxes/devops_0.1.1.box</code></pre>
<p>Note the raised version number <code>0.1.1</code> in the output filename!</p>
<p>Your directory listing of <code>~/VagrantBoxes</code> should look like this now:</p>
<pre><code class="language-bash">$ ls -a1 ~/VagrantBoxes
.
..
devops.json
devops_0.1.0.box
devops_0.1.1.box</code></pre>
<p>If you wish you can test your new box like done under chapter 3.2.</p>
<h3>4.4 Add the new version to the catalog</h3>
<ul>
<li>Edit the <code>devops.json</code> file in a text editor and extend the content to look like this:</li>
</ul>
<pre><code class="language-json">{
    "name": "devops",
    "description": "This box contains Ubuntu 14.04.1 LTS 64-bit.",
    "versions": [{
        "version": "0.1.0",
        "providers": [{
                "name": "virtualbox",
                "url": "file:///Users/hollodotme/VagrantBoxes/devops_0.1.0.box",
                "checksum_type": "sha1",
                "checksum": "d3597dccfdc6953d0a6eff4a9e1903f44f72ab94"
        }]
    },{
        "version": "0.1.1",
        "providers": [{
                "name": "virtualbox",
                "url": "file:///Users/hollodotme/VagrantBoxes/devops_0.1.1.box",
                "checksum_type": "sha1",
                "checksum": "0b530d05896cfa60a3da4243d03eccb924b572e2"
        }]
    }]
}</code></pre>
<p><strong>Don't forget</strong> to determine the checksum of the newly created box <code>devops_0.1.1.box</code>!</p>
<h3>4.5 Check for outdated vagrant box and update</h3>
<ul>
<li>Change into <code>VagrantTest</code> directory.</li>
</ul>
<pre><code class="language-bash">$ cd ~/VagrantTest</code></pre>
<ul>
<li>Ask if your vagrant box is outdated</li>
</ul>
<pre><code class="language-bash">$ vagrant box outdated
Checking if box 'devops' is up to date...
A newer version of the box 'devops' is available! You currently
have version '0.1.0'. The latest is version '0.1.1'. Run
`vagrant box update` to update.</code></pre>
<p>Suprise, suprise - a new version is available!</p>
<p><strong>Note:</strong> Instead of manually asking for outdated boxes, vagrant will notify you automatically when you use the
Vagrant commands like <code>vagrant up</code>, <code>vagrant reload</code>, <code>vagrant resume</code>, etc.!</p>
<ul>
<li>Update the box</li>
</ul>
<pre><code class="language-bash">$ vagrant box update
==&gt; default: Checking for updates to 'devops'
    default: Latest installed version: 0.1.0
    default: Version constraints:
    default: Provider: virtualbox
==&gt; default: Updating 'devops' with provider 'virtualbox' from version
==&gt; default: '0.1.0' to '0.1.1'...
==&gt; default: Loading metadata for box 'file://~/VagrantBoxes/devops.json'
==&gt; default: Adding box 'devops' (v0.1.1) for provider: virtualbox
    default: Downloading: file://~/VagrantBoxes/devops_0.1.1.box
    default: Calculating and comparing box checksum...
==&gt; default: Successfully added box 'devops' (v0.1.1) for 'virtualbox'!</code></pre>
<p><strong>Note:</strong> The box with version <code>0.1.0</code> still exists. Vagrant will never prune your boxes automatically because of potential data loss.</p>
<ul>
<li>Remove the old box</li>
</ul>
<pre><code class="language-bash">$ vagrant box remove 'devops'
You requested to remove the box 'devops' with provider
'virtualbox'. This box has multiple versions. You must
explicitly specify which version you want to remove with
the `--box-version` flag. The available versions for this
box are:

 * 0.1.0
 * 0.1.1</code></pre>
<p>Okay, so...</p>
<pre><code class="language-bash">$ vagrant box remove 'devops' --box-version '0.1.0'
~/VagrantTest/Vagrantfile:5: warning: already initialized constant VAGRANTFILE_API_VERSION
~/VagrantTest/Vagrantfile:5: warning: previous definition of VAGRANTFILE_API_VERSION was here
Box 'devops' (v0.1.0) with provider 'virtualbox' appears
to still be in use by at least one Vagrant environment. Removing
the box could corrupt the environment. We recommend destroying
these environments first:

default (ID: 3206d9d1a427459daac770f2e7e81f1b)

Are you sure you want to remove this box? [y/N]</code></pre>
<p><strong>N</strong>o! Let's destroy it first.</p>
<pre><code class="language-bash">$ vagrant destroy
    default: Are you sure you want to destroy the 'default' VM? [y/N] y
==&gt; default: Destroying VM and associated drives...</code></pre>
<p>Now remove it, please!</p>
<pre><code class="language-bash">$ vagrant box remove 'devops' --box-version '0.1.0'
Removing box 'devops' (v0.1.0) with provider 'virtualbox'...</code></pre>
<p>Hell yeah!</p>
<h3>4.6 Check for the change</h3>
<ul>
<li>Bring up the machine</li>
</ul>
<pre><code class="language-bash">$ vagrant up</code></pre>
<ul>
<li>SSH into the machine</li>
</ul>
<pre><code class="language-bash">$ vagrant ssh</code></pre>
<p>Now you should see the previously changed version number <code>0.1.1</code> in the message of the day after login.</p>
<pre><code class="language-bash">--
Welcome to devops-template version 0.1.1!
--</code></pre>
<p><strong>So we are up-to-date!</strong></p>
<p><strong>What we did so far:</strong></p>
<ul>
<li>We created a virtual machine template</li>
<li>We built two versioned vagrant boxes out of the virtual machine template</li>
<li>We established a box catalog to serve the versions to the client</li>
<li>We updated an outdated box</li>
</ul>
<p><strong>What we will do now:</strong></p>
<ul>
<li>Hosting the box catalog and the boxes on a webserver a.k.a. set up our own vagrant cloud.</li>
</ul>
<p>So cleanup your desk: exit your SSH session, destroy the vm and remove it from vagrant.</p>
<pre><code class="language-bash">$ exit # On guest</code></pre>
<pre><code class="language-bash">$ vagrant destroy # On host
$ vagrant box remove 'devops'</code></pre>
<h2>5. Hosting</h2>
<p>As I mentioned at the beginning, I assume that you have private/public webserver and access to its config and filesystem.</p>
<p>For explanation I'll use the domain <code>www.example.com</code> targeting to this webserver.
Furthermore <code>www.example.com</code> points to <code>/var/www/</code> on the webserver's filesystem (document root).</p>
<h3>5.1 Suggested directory structure</h3>
<p>To keep things easy I prefer to separate the catalog and the box files physically in the filesystem.
Keep on reading and you'll understand why.</p>
<pre><code class="language-bash">- /var/www                              # document root
        `- vagrant
           `- devops                    # box name folder
              |- boxes                  # contains all available box files
              |  |- devops_0.1.0.box    # version 0.1.0
              |  `- devops_0.1.1.box    # version 0.1.1
              `- devops.json            # box catalog</code></pre>
<p>Translated to URLs we have three targets to care about (we will use these later):</p>
<ul>
<li>The catalog: <a href="http://www.example.com/vagrant/devops/devops.json">http://www.example.com/vagrant/devops/devops.json</a></li>
<li>Box (v0.1.0): <a href="http://www.example.com/vagrant/devops/boxes/devops_0.1.0.box">http://www.example.com/vagrant/devops/boxes/devops_0.1.0.box</a></li>
<li>Box (v0.1.1): <a href="http://www.example.com/vagrant/devops/boxes/devops_0.1.1.box">http://www.example.com/vagrant/devops/boxes/devops_0.1.1.box</a></li>
</ul>
<h3>5.2 Webserver configuration</h3>
<p>I want to explain the basic webserver configuration with nginx on a linux server, because this is my favorite software.
The configuration can be ported to apache and/or windows as well.</p>
<ul>
<li>SSH into your server.</li>
</ul>
<pre><code class="language-bash">$ ssh user@example.com</code></pre>
<ul>
<li>Install nginx</li>
</ul>
<pre><code class="language-bash">$ sudo apt-get install nginx-full</code></pre>
<ul>
<li>Create the target folders and set permissions</li>
</ul>
<pre><code class="language-bash"># Create folders
$ sudo mkdir -p /var/www/vagrant/devops/boxes
# Set owner to www-data
$ sudo chown -R www-data:www-data /var/www
# Set permissions
$ sudo chmod -R 0751 /var/www</code></pre>
<ul>
<li>Delete the <code>default</code> sym-linked config for virtual hosts (vhost)
<ul>
<li>Just to make sure there is no colliding config! </li>
</ul></li>
</ul>
<pre><code class="language-bash">$ sudo rm -rf /etc/nginx/sites-enabled/default</code></pre>
<ul>
<li>Create a new specific vhost config for <code>www.example.com</code></li>
</ul>
<pre><code class="language-bash">sudo nano /etc/nginx/sites-available/example.com</code></pre>
<p>... with the following content:</p>
<pre><code class="language-bash">server {
    listen   80 default_server;
    listen   [::]:80 ipv6only=on default_server;

    server_name example.com www.example.com;

    root /var/www;

    # Match the box name in location and search for its catalog
    # e.g. http://www.example.com/vagrant/devops/ resolves /var/www/vagrant/devops/devops.json  
    location ~ ^/vagrant/([^\/]+)/$ {
        index $1.json;
        try_files $uri $uri/ $1.json =404;
        autoindex off;
    }

    # Enable auto indexing for the folder with box files
    location ~ ^/vagrant/([^\/]+)/boxes/$ {
        try_files $uri $uri/ =404;
        autoindex on;
        autoindex_exact_size on;
        autoindex_localtime on;
    }

    # Serve json files with content type header application/json
    location ~ \.json$ {
        add_header Content-Type application/json;
    }

    # Serve box files with content type application/octet-stream
    location ~ \.box$ {
        add_header Content-Type application/octet-stream;
    }

    # Deny access to document root and the vagrant folder
    location ~ ^/(vagrant/)?$ {
        return 403;
    }
}</code></pre>
<ul>
<li>Sym-link the vhost config to enable it</li>
</ul>
<pre><code class="language-bash">$ sudo ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/000-example.com</code></pre>
<ul>
<li>Restart nginx and exit the webserver</li>
</ul>
<pre><code class="language-bash">$ service nginx restart
$ exit</code></pre>
<h3>5.3 Change the box catalog</h3>
<p>Now, that our boxes won't be stored any longer on the local filesystem, we have to change their locations in the box catalog.</p>
<ul>
<li>Open <code>~/VagrantBoxes/devops.json</code> in your text editor and change the content to this:</li>
</ul>
<pre><code class="language-json">{
    "name": "devops",
    "description": "This box contains Ubuntu 14.04.1 LTS 64-bit.",
    "versions": [{
        "version": "0.1.0",
        "providers": [{
                "name": "virtualbox",
                "url": "http://www.example.com/vagrant/devops/boxes/devops_0.1.0.box",
                "checksum_type": "sha1",
                "checksum": "d3597dccfdc6953d0a6eff4a9e1903f44f72ab94"
        }]
    },{
        "version": "0.1.1",
        "providers": [{
                "name": "virtualbox",
                "url": "http://www.example.com/vagrant/devops/boxes/devops_0.1.1.box",
                "checksum_type": "sha1",
                "checksum": "0b530d05896cfa60a3da4243d03eccb924b572e2"
        }]
    }]
}</code></pre>
<ul>
<li>Upload this file to your webserver to directory <code>/var/www/vagrant/devops/</code>.</li>
</ul>
<p>If you open the URL <a href="http://www.example.com/vagrant/devops/">http://www.example.com/vagrant/devops/</a> in your browser you should see your JSON box catalog.</p>
<h3>5.4 Upload your boxes</h3>
<ul>
<li>Upload both box files to your webserver to directory <code>/var/www/vagrant/devops/boxes/</code>.</li>
</ul>
<p>If you open the URL <a href="http://www.example.com/vagrant/devops/boxes/">http://www.example.com/vagrant/devops/boxes/</a> in your browser you should see a directory
listing with both box files listed.</p>
<h3>5.5 Change the <code>Vagrantfile</code></h3>
<ul>
<li>Change into the <code>~/VagrantTest</code> directory on your host.</li>
</ul>
<pre><code class="language-bash">$ cd ~/VagrantTest</code></pre>
<ul>
<li>Open the <code>Vagrantfile</code> file in your text editor</li>
</ul>
<pre><code class="language-json"># Change the line
config.vm.box_url = "file://~/VagrantBoxes/devops.json"
# to
config.vm.box_url = "http://www.example.com/vagrant/devops/"
# save the file</code></pre>
<h3>5.6 Get finally up and running</h3>
<ul>
<li>Bring up the machine</li>
</ul>
<pre><code class="language-bash">$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
==&gt; default: Box 'devops' could not be found. Attempting to find and install...
    default: Box Provider: virtualbox
    default: Box Version: &gt;= 0
==&gt; default: Loading metadata for box 'http://www.example.com/vagrant/devops/'
    default: URL: http://www.example.com/vagrant/devops/
==&gt; default: Adding box 'devops' (v0.1.1) for provider: virtualbox
    default: Downloading: http://www.example.com/vagrant/devops/boxes/devops_0.1.1.box
    default: Calculating and comparing box checksum...
==&gt; default: Successfully added box 'devops' (v0.1.1) for 'virtualbox'!
==&gt; default: Importing base box 'devops'...
==&gt; default: Matching MAC address for NAT networking...
==&gt; default: Checking if box 'devops' is up to date...
==&gt; default: Setting the name of the VM: VagrantTest_default_1406660957112_34972
==&gt; default: Clearing any previously set network interfaces...
==&gt; default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
==&gt; default: Forwarding ports...
    default: 22 =&gt; 2222 (adapter 1)
==&gt; default: Booting VM...
==&gt; default: Waiting for machine to boot. This may take a few minutes...
    default: SSH address: 127.0.0.1:2222
    default: SSH username: vagrant
    default: SSH auth method: private key
    default: Warning: Connection timeout. Retrying...
    default: Warning: Remote connection disconnect. Retrying...
==&gt; default: Machine booted and ready!
==&gt; default: Checking for guest additions in VM...
==&gt; default: Mounting shared folders...
    default: /vagrant =&gt; ~/VagrantTest</code></pre>
<p><strong>And here it is: Your own vagrant cloud!</strong></p>
<h2>Epilog</h2>
<ul>
<li>Please trigger fixes to this tutorial as an issue to this repo here on github</li>
<li>For questions you can find me in the <a href="https://groups.google.com/forum/#!usersettings/general">vagrant google group</a></li>
<li>Thanks for reading, I hope this helps boosting your environment!</li>
</ul>
<h2>Further reading</h2>
<ul>
<li><a href="https://github.com/ebmeierj/local_vagrant_box_hosting">Sets up a nginx server which hosts vagrant boxes</a> by <a href="https://github.com/ebmeierj">ebmeierj</a></li>
</ul>
<p><small>09/27/2016</small></p>

		
	</div>
</div>
<script src="https://dev.hollo.me/js/theme.js"></script>
<script src="https://dev.hollo.me/js/prism.js"></script>
<link rel="stylesheet" href="https://dev.hollo.me/css/prism.css">
</body>
</html>
