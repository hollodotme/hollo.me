<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>Install XMPP server prosody | Holger Woltersdorf&#039;s blog</title>
	<meta name="description" content="A tutorial on how to install XMPP server prosody with mysql auth backend on Ubuntu">
	<meta name="keywords" content="">
	<meta name="HandheldFriendly" content="True"/>
	<meta name="geo.region" content="DE-SN"/>
	<meta name="geo.placename" content="Dresden"/>
	<meta name="geo.position" content="51.052088;13.741672"/>
	<meta name="ICBM" content="51.052088, 13.741672"/>
	<meta name="twitter:site" content="@hollodotme">
	<meta name="twitter:creator" content="@hollodotme">
	<script type="application/ld+json">{
  "@context" : "http://schema.org",
  "@type": "Person",
  "name": "Holger Woltersdorf&#039;s blog",
  "image": "https://hollo.me/img/Profile.png",
  "url": "https://hollo.me",
  "sameAs" : [
      "https://twitter.com/hollodotme",
      "https://www.xing.com/profile/Holger_Woltersdorf"
    ]
  }
}</script>
	<meta property="article:author" content="https://www.xing.com/profile/Holger_Woltersdorf"/>
	<meta property="article:publisher" content="https://www.xing.com/profile/Holger_Woltersdorf"/>
	<link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
	<link rel="manifest" href="/favicon/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">

	<link rel="canonical" href="https://hollo.me/devops/install-xmpp-server-prosody.html"/>
	<meta name="referrer" content="origin"/>

	<meta property="og:site_name" content="Holger Woltersdorf&#039;s blog"/>
	<meta property="og:type" content="article"/>
	<meta property="og:title" content="Install XMPP server prosody | Holger Woltersdorf&#039;s blog"/>
	<meta property="og:description" content="A tutorial on how to install XMPP server prosody with mysql auth backend on Ubuntu"/>
	<meta property="og:url" content="https://hollo.me"/>
	<meta property="og:image" content="https://hollo.me/img/Profile.png"/>
	<meta property="article:published_time" content="2017-03-07T23:07:37+01:00"/>
	<meta property="article:modified_time" content="2017-03-07T23:07:37+01:00"/>
		<meta name="twitter:card" content="summary_large_image"/>
	<meta name="twitter:title" content="Install XMPP server prosody | Holger Woltersdorf&#039;s blog"/>
	<meta name="twitter:description" content="A tutorial on how to install XMPP server prosody with mysql auth backend on Ubuntu"/>
	<meta name="twitter:url" content="https://hollo.me/devops/install-xmpp-server-prosody.html"/>
	<meta name="twitter:image:src" content="https://hollo.me/img/Profile.png"/>

	<meta name="generator" content="IceHawk Static Page Generator"/>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<link rel="stylesheet" type="text/css" media="screen" href="https://hollo.me/css/theme.css">
	<script src="https://use.fontawesome.com/3513f09ab7.js"></script>
	</head>
<body>
<div class="themewrapper">

	<a href="#" id="sidebar-toggle"><i class="fa fa-close genericon"></i></a>

	<div id="sidebar">
		<div class="brand-well">
			<a href="https://hollo.me">
				<img src="https://hollo.me/img/Profile.png" alt="Holger Woltersdorf">
			</a>
		</div>

		<h3 class="text-center text-uppercase">Holger Woltersdorf</h3>
		<p class="text-center text-uppercase subline">
			CIO &middot; Developer &middot; Speaker<br>
			PHP &middot; WEB &middot; Markdown lover
		</p>

		<hr>

		<ul class="sociallinks">
			<li>
				<a href="https://twitter.com/hollodotme" title="Holger Woltersdorf on twitter (@hollodotme)" target="_blank"><i class="fa fa-twitter"></i></a>
			</li>
			<li>
				<a href="https://www.xing.com/profile/Holger_Woltersdorf" title="Holger Woltersdorf on Xing" target="_blank"><i class="fa fa-xing"></i></a>
			</li>
			<li>
				<a href="https://github.com/hollodotme" title="Holger Woltersdorf on GitHub" target="_blank"><i class="fa fa-github"></i></a>
			</li>
			<li>
				<a href="https://www.linkedin.com/in/holgerwoltersdorf" title="Holger Woltersdorf on LinkedIn" target="_blank"><i class="fa fa-linkedin"></i></a>
			</li>
		</ul>

		<hr>

		<ul class="sidebar-nav">
			<li class="hidden-sm hidden-md hidden-lg">
				<a href="https://hollo.me/" title="Home">Home</a>
			</li>
			
						<li>
		<a href="https://hollo.me/php.html">PHP</a>
			</li>


			
						<li>
		<a href="https://hollo.me/talks.html">Talks</a>
			</li>


			
						<li>
		<a href="https://hollo.me/projects.html">Projects</a>
			</li>


			
						<li class="active">
		<a href="https://hollo.me/devops.html">DevOps</a>
					<ul class="nav">
															<li>
		<a href="https://hollo.me/devops/self-hosted-vagrant-cloud.html">Self-hosted &#039;vagrant cloud&#039;</a>
			</li>

											<li class="active">
		<a href="https://hollo.me/devops/install-xmpp-server-prosody.html">Install XMPP server prosody</a>
			</li>

							</ul>
			</li>


			
						<li>
		<a href="https://hollo.me/reading-list.html">Reading list</a>
			</li>


			
						<li>
		<a href="https://hollo.me/imprint.html">Imprint</a>
			</li>


					</ul>

		<hr>

		<div class="text-center">
			<p>
				<small>Co-Founder of</small>
			</p>
			<a href="http://phpug-dresden.org" target="_blank">
				<img src="https://hollo.me/img/php-usergroup-dresden.png" alt="PHP USERGROUP DRESDEN e.V." class="img img-50">
			</a>
		</div>

		<hr>

		<p class="text-center website-version">
			<small>v1.0.0</small>
		</p>

	</div>

	<div id="breadcrumbs">
		<ul>
												<li>
						<a href="https://hollo.me/index.html">
							<i class="fa fa-map-marker"></i> Home
						</a>
					</li>
																<li>
						<a href="https://hollo.me/devops.html">
							 DevOps
						</a>
					</li>
																<li class="active">
						 Install XMPP server prosody
					</li>
									</ul>
	</div>

	<div id="main">

		
			<h1>Install XMPP server prosody</h1>
			<h5>A tutorial on how to install XMPP server prosody with mysql auth backend on Ubuntu</h5>

			<hr>

			<h2>Preamble</h2>
<p>Prosody is an alternative to ejabberd and is focused on easy setup and configuration and being efficient with system resources.
You can find all the information about prosody <a href="http://prosody.im">here</a>.</p>
<h3>What we will do in this tutorial</h3>
<ul>
<li>Of course, install Prosody</li>
<li>Configure Prosody to use a MySQL backend for authentication</li>
</ul>
<h3>What you will need</h3>
<ul>
<li>ssh access to an ubuntu server with sudo privileges</li>
<li>Maybe a frontend for your MySQL server like phpMyAdmin if you're not familiar with the MySQL command line interface</li>
<li>A sub-domain to run the jabber server on</li>
<li>Make sure your server is accessable on port <strong>5222</strong>.</li>
</ul>
<hr />
<h2>1. Configure your domains</h2>
<ul>
<li>Your server should have an IP address, I will use the <code>10.100.10.1</code> for demonstration.</li>
<li>I will use the following domains to run the XMPP server on:
<ul>
<li>jabber.hollo.me</li>
<li>conference.jabber.hollo.me</li>
</ul></li>
</ul>
<p>Of course, you should replace the IP and the domains with your real world ones.</p>
<h3>Local configuration via /etc/hosts</h3>
<p>Edit your <code>/etc/hosts</code> and add the following line to it:</p>
<pre><code class="language-bash">10.100.10.1     jabber.hollo.me conference.jabber.hollo.me</code></pre>
<p>Save the file. That's it.</p>
<p>This configuration is only for testing the service. </p>
<h3>Domain provider / DNS configuration</h3>
<ul>
<li>Setup the A-Record of your two domains to point on the IP 10.100.10.1</li>
</ul>
<p>You'll have to do this, if your server should be reachable for other clients in a public or private network.
Makes sense. :)</p>
<hr />
<h2>2. Install MySQL and Prosody</h2>
<h3>SSH into your server</h3>
<pre><code class="language-bash">ssh user-with-sudo@jabber.hollo.me</code></pre>
<h3>Update your system (optional)</h3>
<pre><code class="language-bash">jabber.hollo.me$ sudo apt-get update &amp;&amp; apt-get dist-upgrade -y</code></pre>
<h3>Install all packages we will need</h3>
<pre><code class="language-bash">jabber.hollo.me$ sudo apt-get install mysql-server-5.5 mysql-client-5.5 prosody lua-dbi-mysql</code></pre>
<p>Standard MySQL server will do the job, but I prefer using the percona derivate of MySQL, so this line would look like this:</p>
<pre><code class="language-bash">jabber.hollo.me$ sudo apt-get install percona-xtradb-cluster-server-5.5 percona-xtradb-cluster-client-5.5 prosody lua-dbi-mysql</code></pre>
<ul>
<li>You will be asked for a root password for your mysql server during installation; set one you like.</li>
<li>After installation both, the mysql server and the prosody server are up and running.</li>
</ul>
<h3>Secure your MySQL server (optional, but strictly recommended)</h3>
<pre><code class="language-bash">jabber.hollo.me$ sudo mysql_secure_installation</code></pre>
<hr />
<h2>3. Configure MySQL and Prosody</h2>
<h3>Login to your MySQL server</h3>
<pre><code class="language-bash">jabber.hollo.me$ mysql -u root -p</code></pre>
<h3>Create a database named &quot;prosody&quot;</h3>
<pre><code class="language-sql">mysql&gt; CREATE DATABASE `prosody`;</code></pre>
<h3>Create a user names &quot;prosody&quot; and grant all privileges for database &quot;prosody&quot;</h3>
<pre><code class="language-sql">mysql&gt; CREATE USER 'prosody'@'localhost' IDENTIFIED BY 'secret'; # Replace 'secret' with a password you like!
mysql&gt; GRANT ALL PRIVILEGES ON prosody.* TO 'prosody'@'localhost';
mysql&gt; quit</code></pre>
<h3>Configure Prosody to use the MySQL backend</h3>
<p>Edit <code>/etc/prosody/prosody.cfg.lua</code>:</p>
<pre><code class="language-bash">jabber.hollo.me$ sudo nano /etc/prosody/prosody.cfg.lua</code></pre>
<p>Search for the following config block:</p>
<pre><code>--storage = "sql" -- Default is "internal" (Debian: "sql" requires one of the
-- lua-dbi-sqlite3, lua-dbi-mysql or lua-dbi-postgresql packages to work)

-- For the "sql" backend, you can uncomment *one* of the below to configure:
--sql = { driver = "SQLite3", database = "prosody.sqlite" } -- Default. 'database' is the filename.
--sql = { driver = "MySQL", database = "prosody", username = "prosody", password = "secret", host = "localhost" }
--sql = { driver = "PostgreSQL", database = "prosody", username = "prosody", password = "secret", host = "localhost" }</code></pre>
<p>Now uncomment the first and the sixth line of this block (remove the <code>--</code> and line start)</p>
<p>The block should now look like this:</p>
<pre><code>storage = "sql" -- Default is "internal" (Debian: "sql" requires one of the
-- lua-dbi-sqlite3, lua-dbi-mysql or lua-dbi-postgresql packages to work)

-- For the "sql" backend, you can uncomment *one* of the below to configure:
--sql = { driver = "SQLite3", database = "prosody.sqlite" } -- Default. 'database' is the filename.
sql = { driver = "MySQL", database = "prosody", username = "prosody", password = "secret", host = "localhost" }
--sql = { driver = "PostgreSQL", database = "prosody", username = "prosody", password = "secret", host = "localhost" }</code></pre>
<ul>
<li>Replace &quot;secret&quot; with the password you set for the MySQL user 'prosody'.</li>
<li>Leave anything else as is.</li>
<li>Save the file and exit nano.</li>
</ul>
<p><strong>Note:</strong> By default Prosody will handle the database scheme by itself the first time it is needed. So we don't need to create tables ourselves. </p>
<h3>Create a VHost for Prosody with your domains</h3>
<p>First, create a copy of the example.com VHost file:</p>
<pre><code class="language-bash">jabber.hollo.me$ sudo cp /etc/prosody/conf.avail/example.com.cfg.lua /etc/prosody/conf.avail/jabber.hollo.me.cfg.lua</code></pre>
<p>Edit <code>/etc/prosody/conf.avail/jabber.hollo.me.cfg.lua</code>:</p>
<pre><code class="language-bash">jabber.hollo.me$ sudo nano /etc/prosody/conf.avail/jabber.hollo.me.cfg.lua</code></pre>
<p>The config should look like this:</p>
<pre><code>-- Section for example.com

VirtualHost "example.com"
        enabled = false -- Remove this line to enable this host

        -- Assign this host a certificate for TLS, otherwise it would use the one
        -- set in the global section (if any).
        -- Note that old-style SSL on port 5223 only supports one certificate, and will always
        -- use the global one.
        ssl = {
                key = "/etc/prosody/certs/example.com.key";
                certificate = "/etc/prosody/certs/example.com.crt";
                }

------ Components ------
-- You can specify components to add hosts that provide special services,
-- like multi-user conferences, and transports.
-- For more information on components, see http://prosody.im/doc/components

-- Set up a MUC (multi-user chat) room server on conference.example.com:
Component "conference.example.com" "muc"

-- Set up a SOCKS5 bytestream proxy for server-proxied file transfers:
--Component "proxy.example.com" "proxy65"

---Set up an external component (default component port is 5347)
--Component "gateway.example.com"
--      component_secret = "password"</code></pre>
<p>Edit the content to look like this:</p>
<pre><code>-- Section for jabber.hollo.me

VirtualHost "jabber.hollo.me"

Component "conference.jabber.hollo.me" "muc"</code></pre>
<ul>
<li>Save the file and exit nano.</li>
<li>Yes, that's all we need.</li>
</ul>
<p>Now create a symlink to activate the VHost. Prosody automatically loads all VHosts under <code>/etc/prosody/conf.d</code>.</p>
<pre><code class="language-bash">jabber.hollo.me$ sudo ln -sf ../conf.avail/jabber.hollo.me.cfg.lua /etc/prosody/conf.d/jabber.hollo.me.cfg.lua</code></pre>
<h3>Restart Prosody</h3>
<p>The basic configuration is done. Now restart Prosody to let the changes take effect.</p>
<pre><code class="language-bash">jabber.hollo.me$ sudo service prosody restart</code></pre>
<hr />
<h2>4. Create jabber users</h2>
<ul>
<li>Prosody serves a command line interface <code>prosodyctl</code> that easily lets you register some users.</li>
<li>We will add two test users for demonstration</li>
</ul>
<pre><code class="language-bash">jabber.hollo.me$ sudo prosodyctl register testuser1 jabber.hollo.me secret1
jabber.hollo.me$ sudo prosodyctl register testuser2 jabber.hollo.me secret2</code></pre>
<p><strong>Note:</strong> This is the first time Prosody uses the MySQL backend and will apply the nessecary database scheme.</p>
<h3>Check if database scheme was applied (optional)</h3>
<p>Login to your MySQL server:</p>
<pre><code class="language-bash">jabber.hollo.me$ mysql -u root -p</code></pre>
<p>Show all tables in database <code>prosody</code>:</p>
<pre><code class="language-sql">mysql&gt; SHOW TABLES FROM `prosody`; </code></pre>
<p>Output should look like this:</p>
<pre><code>+-------------------+
| Tables_in_prosody |
+-------------------+
| prosody           |
+-------------------+
1 row in set (0.00 sec)</code></pre>
<p>Now check, if our two testusers were inserted.</p>
<pre><code class="language-sql">mysql&gt; SELECT * FROM `prosody`.`prosody` WHERE 1; </code></pre>
<p>Output should look like this:</p>
<pre><code>+-----------------+-----------+----------+----------+--------+---------+
| host            | user      | store    | key      | type   | value   |
+-----------------+-----------+----------+----------+--------+---------+
| jabber.hollo.me | testuser1 | accounts | password | string | secret1 |
| jabber.hollo.me | testuser2 | accounts | password | string | secret2 |
+-----------------+-----------+----------+----------+--------+---------+
2 rows in set (0.00 sec)</code></pre>
<p><strong>Note:</strong> By default the user's secrets are stored in plaintext. You can enable hashing in the config, see:
<a href="http://prosody.im/doc/modules/mod_auth_internal_hashed">mod_auth_internal_hashed</a></p>
<p><small>08/02/2015</small></p>

		
	</div>
</div>
<script src="https://hollo.me/js/theme.js"></script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.9.0/styles/default.min.css">
<script src="//cdn.jsdelivr.net/highlight.js/9.9.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
