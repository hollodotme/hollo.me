<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>Routing to multiple docker-compose setups using traefik | Holger Woltersdorf&#039;s blog</title>
	<meta name="description" content="A tutorial that describes the steps to setup a local reverse proxy with traefik that globally performs SSL offloading and routing to multiple docker-compose development setups.">
	<meta name="keywords" content="">
	<meta name="HandheldFriendly" content="True"/>
	<meta name="geo.region" content="DE-SN"/>
	<meta name="geo.placename" content="Dresden"/>
	<meta name="geo.position" content="51.052088;13.741672"/>
	<meta name="ICBM" content="51.052088, 13.741672"/>
	<meta name="twitter:site" content="@hollodotme">
	<meta name="twitter:creator" content="@hollodotme">
	<script type="application/ld+json">{
  "@context" : "http://schema.org",
  "@type": "Person",
  "name": "Holger Woltersdorf&#039;s blog",
  "image": "https://dev.hollo.me/img/posts/traefik-routing-multi-docker-compose.png",
  "url": "https://dev.hollo.me",
  "sameAs" : [
      "https://twitter.com/hollodotme",
      "https://www.xing.com/profile/Holger_Woltersdorf"
    ]
  }
}</script>
	<meta property="article:author" content="https://www.xing.com/profile/Holger_Woltersdorf"/>
	<meta property="article:publisher" content="https://www.xing.com/profile/Holger_Woltersdorf"/>
	<link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
	<link rel="manifest" href="/favicon/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">

	<link rel="canonical" href="https://dev.hollo.me/devops/routing-to-multiple-docker-compose-development-setups-with-traefik.html"/>
	<meta name="referrer" content="origin"/>

	<meta property="og:site_name" content="Holger Woltersdorf&#039;s blog"/>
	<meta property="og:type" content="article"/>
	<meta property="og:title" content="Routing to multiple docker-compose setups using traefik | Holger Woltersdorf&#039;s blog"/>
	<meta property="og:description" content="A tutorial that describes the steps to setup a local reverse proxy with traefik that globally performs SSL offloading and routing to multiple docker-compose development setups."/>
	<meta property="og:url" content="https://dev.hollo.me"/>
	<meta property="og:image" content="https://dev.hollo.me/img/posts/traefik-routing-multi-docker-compose.png"/>
	<meta property="article:published_time" content="2019-10-07T07:32:34+00:00"/>
	<meta property="article:modified_time" content="2019-10-07T07:32:34+00:00"/>
		<meta name="twitter:card" content="summary_large_image"/>
	<meta name="twitter:title" content="Routing to multiple docker-compose setups using traefik | Holger Woltersdorf&#039;s blog"/>
	<meta name="twitter:description" content="A tutorial that describes the steps to setup a local reverse proxy with traefik that globally performs SSL offloading and routing to multiple docker-compose development setups."/>
	<meta name="twitter:url" content="https://dev.hollo.me/devops/routing-to-multiple-docker-compose-development-setups-with-traefik.html"/>
	<meta name="twitter:image:src" content="https://dev.hollo.me/img/posts/traefik-routing-multi-docker-compose.png"/>

	<meta name="generator" content="IceHawk Static Page Generator"/>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<link href="https://fonts.googleapis.com/css?family=Oxygen|Oxygen+Mono" rel="stylesheet">
	<link rel="stylesheet" type="text/css" media="screen" href="https://dev.hollo.me/css/theme.css">
	<script src="https://use.fontawesome.com/3513f09ab7.js"></script>
	</head>
<body>
<div class="themewrapper">

	<a href="#" id="sidebar-toggle"><i class="fa fa-close genericon"></i></a>

	<div id="sidebar">
		<div class="brand-well">
			<a href="https://dev.hollo.me">
				<img src="https://dev.hollo.me/img/sunny-me.jpg" alt="Holger Woltersdorf">
			</a>
		</div>

		<h3 class="text-center text-uppercase">Holger Woltersdorf</h3>
		<p class="text-center text-uppercase subline">
			CIO &middot; Developer &middot; Speaker<br>
			PHP &middot; WEB &middot; Community
		</p>

		<hr>

		<ul class="sociallinks">
			<li>
				<a href="https://twitter.com/hollodotme" title="Holger Woltersdorf on twitter (@hollodotme)" target="_blank"><i class="fa fa-twitter"></i></a>
			</li>
			<li>
				<a href="https://www.xing.com/profile/Holger_Woltersdorf" title="Holger Woltersdorf on Xing" target="_blank"><i class="fa fa-xing"></i></a>
			</li>
			<li>
				<a href="https://github.com/hollodotme" title="Holger Woltersdorf on GitHub" target="_blank"><i class="fa fa-github"></i></a>
			</li>
			<li>
				<a href="https://www.linkedin.com/in/holgerwoltersdorf" title="Holger Woltersdorf on LinkedIn" target="_blank"><i class="fa fa-linkedin"></i></a>
			</li>
		</ul>

		<hr>

		<ul class="sidebar-nav">
			<li class="hidden-sm hidden-md hidden-lg">
				<a href="https://dev.hollo.me/" title="Home">Home</a>
			</li>
			
						<li>
		<a href="https://dev.hollo.me/php.html">PHP</a>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/talks.html">Talks</a>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/projects.html">Projects</a>
			</li>


			
						<li class="active">
		<a href="https://dev.hollo.me/devops.html">DevOps</a>
					<ul class="nav">
															<li class="active">
		<a href="https://dev.hollo.me/devops/routing-to-multiple-docker-compose-development-setups-with-traefik.html">Multi development setup routing</a>
			</li>

											<li>
		<a href="https://dev.hollo.me/devops/self-hosted-vagrant-cloud.html">Self-hosted &#039;vagrant cloud&#039;</a>
			</li>

											<li>
		<a href="https://dev.hollo.me/devops/install-xmpp-server-prosody.html">Install XMPP server prosody</a>
			</li>

							</ul>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/reading-list.html">Reading list</a>
			</li>


			
						<li>
		<a href="https://dev.hollo.me/imprint.html">Imprint</a>
			</li>


						<li>
				<a href="https://www.papercall.io/speakers/hollodotme" target="_blank" title="My profile on papercall.io">
					PaperCall.io profile
				</a>
			</li>
			<li>
				<a href="https://speakerdeck.com/hollodotme" target="_blank" title="My profile on speakerdeck.com">
					SpeakerDeck profile
				</a>
			</li>
		</ul>

		<hr>

		<div class="text-center">
			<p>
				<small>Co-Founder of</small>
			</p>
			<a href="http://phpug-dresden.org" target="_blank">
				<img src="https://dev.hollo.me/img/php-usergroup-dresden.png" alt="PHP USERGROUP DRESDEN e.V." class="img img-50">
			</a>
		</div>

		<hr>

		<p class="text-center">
			<strong>Found a bug or a typo?</strong><br>
			This website is open source,<br>
			<a href="https://github.com/hollodotme/hollo.me" target="_blank" title="Website GitHub repository">please fork it and provide a PR</a>.
		</p>
		<p class="text-center website-version">
			<small>v1.2.1</small>
		</p>

	</div>

	<div id="breadcrumbs">
		<ul>
												<li>
						<a href="https://dev.hollo.me/index.html">
							<i class="fa fa-map-marker"></i> Home
						</a>
					</li>
																<li>
						<a href="https://dev.hollo.me/devops.html">
							 DevOps
						</a>
					</li>
																<li class="active">
						 Multi development setup routing
					</li>
									</ul>
	</div>

	<div id="main">

		
			<h1>Routing to multiple docker-compose setups using traefik</h1>
			<h5>A tutorial that describes the steps to setup a local reverse proxy with traefik that globally performs SSL offloading and routing to multiple docker-compose development setups.</h5>
			<hr>

			<p><a href="https://dev.hollo.me/img/posts/traefik-routing-multi-docker-compose.svg"><img src="https://dev.hollo.me/img/posts/traefik-routing-multi-docker-compose.svg" alt="traefik & docker-compose network schema" /></a></p>
<hr />
<nav role="doc-toc" style="width: 45%; float: right; border-left: 3px solid #efefef; padding-left: 15px;">
    <h3>Table of contents</h3>
    <ul>
        <li>
            <a href="#chapter-1">CHAPTER 1: Create valid SSL certificates</a>
        </li>
        <li>
            <a href="#chapter-2">CHAPTER 2: Set up traefik as reverse proxy</a>
        </li>
        <li>
            <a href="#digression-autostart-traefik">DIGRESSION: Autostart traefik on login</a>
        </li>
        <li>
            <a href="#chapter-3">CHAPTER 3: Development project setups</a>
        </li>
        <li>
            <a href="#chapter-4">CHAPTER 4: Domain resolution</a>
        </li>
        <li>
            <a href="#summary">SUMMARY</a>
        </li>
    </ul>
</nav>
<h3>Prerequisites</h3>
<p>To follow this tutorial, I assume that you have:</p>
<ul>
<li><a href="https://www.docker.com/products/docker-desktop">docker</a> installed on your machine</li>
<li><a href="https://docs.docker.com/compose/install/">docker-compose</a> installed on your machine</li>
</ul>
<h3>Goals</h3>
<p>The goals of this tutorial are:</p>
<ul>
<li>Set up <em>ONE</em> traefik instance that handles SSL offloading and HTTP/S routing to multiple web development environments that run in docker-compose setups.</li>
<li>Set up two web development environments with two (sub-)domains each and HTTPS support</li>
</ul>
<hr />
<p><a name="chapter-1"></a></p>
<h3>CHAPTER 1: Create valid SSL certificates</h3>
<p>Thanks to the work of <a href="https://github.com/FiloSottile">Filippo Valsorda</a> we can install/use the tool <a href="https://github.com/FiloSottile/mkcert#install">mkcert</a> in order to create locally-trusted SSL certificates
on our machine. <code>mkcert</code> installs a certificate authority (CA) to your local trust store and the mozilla firefox trust
store (if available) to sign any certificate you want to generate for local development purposes.</p>
<h4>How to download &amp; install <code>mkcert</code>?</h4>
<p>You can either follow one of the installation instruction for your operating system <a href="https://github.com/FiloSottile/mkcert#installation">using package managers here</a>
or download and install <a href="https://github.com/FiloSottile/mkcert/releases">pre-build binaries from here</a>.</p>
<h4>How to create certificates?</h4>
<p>In order to create a certificate(s) just run one of the following commands.</p>
<p><strong>HINT:</strong> The name of the first domain name is used for the certificate filenames.
To not confuse yourself, create a certificate for <strong>only one main domain</strong>.</p>
<h5>Create a wildcard certificate for one domain</h5>
<pre><code class="language-bash">$ mkcert "*.the-domain.com"</code></pre>
<p>This generates two files:</p>
<ol>
<li><code>_wildcard.the-domain.com.pem</code></li>
<li><code>_wildcard.the-domain.com-key.pem</code></li>
</ol>
<p>You should see output like this:</p>
<pre><code class="language-text">Using the local CA at "/Users/hollodotme/Library/Application Support/mkcert" ‚ú®

Created a new certificate valid for the following names üìú
 - "*.the-domain.com"

Reminder: X.509 wildcards only go one level deep, so this won't match a.b.the-domain.com ‚ÑπÔ∏è

The certificate is at "./_wildcard.the-domain.com.pem" and the key at "./_wildcard.the-domain.com-key.pem" ‚úÖ</code></pre>
<h5>Create specific subdomains certificates</h5>
<pre><code class="language-bash">$ mkcert "dev.the-domain.com" "api.the-domain.com"</code></pre>
<p>This again generates only two files:</p>
<ol>
<li><code>dev.the-domain.com+1.pem</code></li>
<li><code>dev.the-domain.com+1-key.pem</code></li>
</ol>
<p>You should see output like this:</p>
<pre><code class="language-text">Using the local CA at "/Users/hollodotme/Library/Application Support/mkcert" ‚ú®

Created a new certificate valid for the following names üìú
 - "dev.the-domain.com"
 - "api.the-domain.com"

The certificate is at "./dev.the-domain.com+1.pem" and the key at "./dev.the-domain.com+1-key.pem" ‚úÖ</code></pre>
<h4>Where to place the certificates?</h4>
<p>Your generated certificates are only valid on your local machine and therefore...</p>
<ul>
<li>should <strong>not</strong> be shared or committed to any project via VCS,</li>
<li>should be stored on a central place, so you can use them everywhere.</li>
</ul>
<p>A good place for example is: <code>~/ssl</code> in your local user's home directory.</p>
<p><a name="generate-certificates-for-our-tutorial"></a></p>
<h4>Generate certificates for our tutorial</h4>
<p>As shown on the picture above we want to have two web development setups that have two sub-domains each.</p>
<ul>
<li>dev.project1.com</li>
<li>readis.project1.com</li>
<li>dev.project2.com</li>
<li>readis.project2.com</li>
</ul>
<p>The following commands will create a wildcard certificate for each project:</p>
<pre><code class="language-bash">$ cd ~/ssl
~/ssl $ mkcert "*.project1.com"
~/ssl $ mkcert "*.project2.com"</code></pre>
<p>This should generate the following files:</p>
<pre><code class="language-text">~/ssl
 |- _wildcard.project1.com-key.pem
 |- _wildcard.project1.com.pem
 |- _wildcard.project2.com-key.pem
 `- _wildcard.project2.com.pem</code></pre>
<hr />
<p><a name="chapter-2"></a></p>
<h3>CHAPTER 2: Set up traefik as reverse proxy</h3>
<p>The reason I use <a href="https://traefik.io">traefik</a> as the global reverse proxy here is that it is able to watch the docker daemon and
automatically discover newly started services, e.g. by bringing up a new docker-compose setup.</p>
<p>Furthermore traefik is able to react on frontend rules represented by labels in docker-compose configurations which makes it
very easy to assign (sub-)domains to services, so traefik can route traffic to them.</p>
<h4>How to configure traefik?</h4>
<p>traefik needs one configuration file, named <code>traefik.toml</code>.<br />
The following basic configuration instructs traefik to:</p>
<ul>
<li>listen for HTTP (Port 80) and HTTPS (Port 443) on all local IP addresses (e.g. <code>127.0.0.1</code>)</li>
<li>automatically redirect HTTP traffic to HTTPS</li>
<li>use the listed SSL certificates for the SSL offloading</li>
</ul>
<pre><code class="language-toml">defaultEntryPoints = ["http", "https"]

[entryPoints]
    [entryPoints.http]
    address = ":80" 
        [entryPoints.http.redirect]
        entryPoint = "https"
    [entryPoints.https]
    address = ":443"
    [entryPoints.https.tls]
      [[entryPoints.https.tls.certificates]]
      certFile = "/etc/traefik/ssl/_wildcard.project1.com.pem"
      keyFile = "/etc/traefik/ssl/_wildcard.project1.com-key.pem"
      [[entryPoints.https.tls.certificates]]   # repeat this block to add more SSL certificates
      certFile = "/etc/traefik/ssl/_wildcard.project2.com.pem"
      keyFile = "/etc/traefik/ssl/_wildcard.project2.com-key.pem"

[api]

[docker]</code></pre>
<p>As you can see I referenced the four SSL certificate files I generated in <a href="#generate-certificates-for-our-tutorial">CHAPTER 1</a>.</p>
<p>All you have to do is to replace the names of the SSL certificate files with your actual generated filenames.</p>
<p>You may wonder why the given paths to SSL certificate files is <code>/etc/traefik/ssl/</code>. This is because we will use traefik
as a docker container and will mount the local <code>~/ssl</code> directory to the container's <code>/etc/traefik/ssl/</code> directory as you'll see in a second. </p>
<h4>How to start traefik?</h4>
<p>In order to avoid a long and complex single docker command, we'll use a <code>docker-compose</code> configuration to set up the
traefik instance. This way you can easily (re)start and stop the traefik instance.</p>
<p>Before weg get to the docker-compose setup, we need to create a <a href="https://github.com/containous/traefik/issues/3599">global docker network named &quot;gateway&quot;</a>.
The big blue box in the image above refers to this global network &quot;gateway&quot;.
All other docker-compose setups will later attach to this network with their public backends, e.g. their webservers.</p>
<p><a name="chapter-2-create-gateway-network"></a></p>
<h4>Create the gateway network</h4>
<pre><code class="language-bash">$ docker network create \
  --driver=bridge \
  --attachable \
  --internal=false \
  gateway</code></pre>
<p>The important part here is the option <code>--internal=false</code>.</p>
<p><strong>Note:</strong> This network will survive a restart of the docker daemon or your machine and must be created only once. </p>
<h4>docker-compose.yml</h4>
<p>The following <code>docker-compose.yml</code> should be ready to use, if you put your SSL certificates to <code>~/ssl</code>
as in <a href="#generate-certificates-for-our-tutorial">CHAPTER 1</a>.</p>
<pre><code class="language-yaml">version: "3"

services:
  traefik:
    image: traefik
    container_name: global_traefik
    restart: "always"
    ports:
      # Port 443 is used for HTTP trafic
      - "80:80"
      # Port 443 is used for HTTPS trafic
      - "443:443"
      # Port 8080 is used for traefik's own dashboard
      - "8080:8080"
    volumes:
      # Here is the mount of the traefik config
      - ./traefik.toml:/etc/traefik/traefik.toml:ro
      # Here is the mount of the local ~/ssl directory
      - ~/ssl:/etc/traefik/ssl:ro
      # The docker socket is mounted for auto-discovery of new services
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      # Attach the traefik container to the default network (which is the global "gateway" network)
      - default

# Make the externally created network "gateway" available as network "default"
networks:
  default:
    external: 
      name: gateway</code></pre>
<h4>Bring it up</h4>
<p>Now start the traefik instance with the following command:</p>
<pre><code class="language-bash">$ docker-compose up -d</code></pre>
<p>You can check, if the traefik instance is properly running with:</p>
<pre><code class="language-bash">$ docker-compose ps</code></pre>
<p>This should give the following output:</p>
<pre><code class="language-text">     Name        Command    State                                Ports
----------------------------------------------------------------------------------------------------
global_traefik   /traefik   Up      0.0.0.0:443-&gt;443/tcp, 0.0.0.0:80-&gt;80/tcp, 0.0.0.0:8080-&gt;8080/tcp</code></pre>
<h4>Check the traefik dashboard</h4>
<p>traefik comes with a built-in dashboard showing you all container instances that are running, their health
and how they could be accessed.</p>
<p><strong>Open:</strong> <a href="http://127.0.0.1:8080/dashboard/">http://127.0.0.1:8080/dashboard/</a> </p>
<p>You should see something like this:</p>
<p><a href="https://dev.hollo.me/img/posts/traefik-dashboard.png"><img src="https://dev.hollo.me/img/posts/traefik-dashboard.png" alt="traefik dashboard" /></a></p>
<h4>Where to place the traefik configs?</h4>
<p>In order to use traefik as a global reverse proxy on your machine all the files should be placed in a central place.
A good place to put them is <code>~/traefik</code> in your local user's home directory, alongside with your local SSL certificates.</p>
<pre><code class="language-text">~
|- /ssl
|  |- _wildcard.the-domain.com.pem
|  `- _wildcard.the-domain.com-key.pem
`- /traefik
   |- docker-compose.yml
   `- traefik.toml</code></pre>
<hr />
<p><a name="digression-traefik-autostart"></a></p>
<h3>DIGRESSION: Autostart traefik on login</h3>
<p>The traefik service should be always available in order to quickly start working on your projects.
So it makes sense to add it as an autostart item to your system.</p>
<p>As a Mac user I can create a shell script and a <code>.plist</code> file that will be registered to OSX' <code>launchd</code>.</p>
<h4>~/traefik/autostart.sh</h4>
<pre><code class="language-bash">#!/bin/bash

DOCKER_APP=/Applications/Docker.app
DOCKER="/usr/local/bin/docker"
DOCKER_COMPOSE="/usr/local/bin/docker-compose"
TRAEFIK_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &gt;/dev/null 2&gt;&amp;1 &amp;&amp; pwd )"

echo ${TRAEFIK_DIR}

# Create global gateway network, if not exists
${DOCKER} network create --driver bridge --attachable --internal=false gateway || true

# Open Docker, only if is not running
if (! ${DOCKER} stats --no-stream ); then
  # Start Docker.app
  open ${DOCKER_APP}
  # Wait until Docker daemon is running and has completed initialisation
  while (! ${DOCKER} stats --no-stream ); do
    # Docker takes a few seconds to initialize
    echo "Waiting for Docker to launch..."
    sleep 1
  done
fi

cd ${TRAEFIK_DIR}

${DOCKER_COMPOSE} up -d --force-recreate</code></pre>
<h4>~/Library/LaunchAgents/com.user.traefik.autostart.plist</h4>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
    &lt;dict&gt;
        &lt;key&gt;Label&lt;/key&gt;
        &lt;string&gt;com.user.traefik.autostart&lt;/string&gt;
        &lt;key&gt;Program&lt;/key&gt;
        &lt;string&gt;/Users/hollodotme/traefik/autostart.sh&lt;/string&gt;
        &lt;key&gt;RunAtLoad&lt;/key&gt;
        &lt;true/&gt;
        &lt;key&gt;StandardErrorPath&lt;/key&gt;
        &lt;string&gt;/Users/hollodotme/Library/Logs/traefik.autostart.log&lt;/string&gt;
        &lt;key&gt;StandardOutPath&lt;/key&gt;
        &lt;string&gt;/Users/hollodotme/Library/Logs/traefik.autostart.log&lt;/string&gt;
        &lt;key&gt;WorkingDirectory&lt;/key&gt;
        &lt;string&gt;/Users/hollodotme/traefik&lt;/string&gt;
    &lt;/dict&gt;
&lt;/plist&gt;</code></pre>
<h5>Load the service with launchd</h5>
<pre><code class="language-bash">$ launchctl load ~/Library/LaunchAgents/com.user.traefik.autostart.plist</code></pre>
<p>The <code>autostart.sh</code> should be executed immediately after the previous command, so you can check the output of the script
in the specified log file: </p>
<pre><code class="language-bash">$ tail -F ~/Library/Logs/traefik.autostart.log</code></pre>
<p>You can find my complete traefik autostart configuration in
<a href="https://github.com/hollodotme/traefik-proxy-autostart">this git repository</a>.
Feedback and improvements are always welcome. </p>
<hr />
<p><a name="chapter-3"></a></p>
<h3>CHAPTER 3: Development project setups</h3>
<p>In order to demonstrate the routing into different development setups using traefik, I set up two identical docker-compose
configurations that only differ in:</p>
<ul>
<li>the name of the internal network they are creating/using</li>
<li>the name of the domain under which they are reachable</li>
<li>the output of their startpage</li>
</ul>
<p>A typical web project setup that I use consists of the following components/services/containers (as you can see in the yellow boxes of the picture above):</p>
<ul>
<li><a href="https://nginx.org">nginx</a> as webserver</li>
<li><a href="https://php.net/fpm">php-fpm</a> as application server</li>
<li><a href="https://mariadb.org">MariaDB</a> as persitent data storage</li>
<li><a href="https://redis.io">redis</a> as session storage and in-memory cache</li>
<li><a href="https://github.com/hollodotme/readis">re<sup>a</sup>dis</a> as web UI for redis</li>
<li><a href="https://getcomposer.org">composer</a> for installing dependencies</li>
</ul>
<h4>File listings of project1 &amp; project2</h4>
<div style="float: left; width: 45%;">
<pre class="language-text"><code class="language-text">/path/to/project1
|- /.docker
|  |- /nginx
|  |  `- /default.conf
|  |- /php
|  |  `- Dockerfile
|  `- /readis
|     |- /app.php
|     `- /servers.php
|- /data
|  `- /mariadb
|- /public
|  `- /index.php
`- docker-compose.yml</code></pre>
</div>
<div style="float: right; width: 45%;">
<pre class="language-text"><code class="language-text">/path/to/project2
|- /.docker
|  |- /nginx
|  |  `- /default.conf
|  |- /php
|  |  `- Dockerfile
|  `- /readis
|     |- /app.php
|     `- /servers.php
|- /data
|  `- /mariadb
|- /public
|  `- /index.php
|- composer.json
`- docker-compose.yml</code></pre>
</div>
<p><br style="clear: both"></p>
<p>I'll go through these files one by one for project1. The files for project2 look exactly the same beside the fact that
&quot;project1&quot; is replaced with &quot;project2&quot; everywhere.</p>
<h4>project1/docker-compose.yml</h4>
<p>This is the full docker-compose configuraton for project1.</p>
<pre><code class="language-yaml">version: "3"

services:
  nginx:
    image: nginx
    container_name: "project1_nginx"
    volumes:
    - ./:/app:ro
    - ./.docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: "always"
    labels:
      - "traefik.frontend.rule=HostRegexp:{subdomain:[a-z]+}.project1.com"
    networks:
    - default
    - project1

  php:
    build: 
      dockerfile: Dockerfile
      context: ./.docker/php
    container_name: "project1_php"
    volumes:
    - ./:/app
    restart: "always"
    networks:
    - project1

  db:
    image: mariadb:10.2
    container_name: "project1_db"
    restart: "always"
    environment:
      MYSQL_ROOT_PASSWORD: root
    volumes:
    - ./data/mariadb:/var/lib/mysql
    networks:
    - project1

  redis:
    image: redis
    container_name: "project1_redis"
    restart: "always"
    networks:
      - project1

  readis:
    image: hollodotme/readis
    container_name: "project1_readis"
    restart: "always"
    volumes:
      - ./.docker/readis:/code/config:ro
    networks:
      - project1

  composer:
      image: composer
      container_name: "project1_composer"
      restart: "no"
      volumes:
        - ./:/app
      networks:
        - default
      command: "update -o -v"

networks:
  default:
    external:
      name: gateway

  project1:
    internal: true</code></pre>
<h5>Network configuration</h5>
<p>The configuration defines two networks for the set up. The first network &quot;default&quot; is the global &quot;gateway&quot; network that we
created externally as described in <a href="#chapter-2-create-gateway-network">CHAPTER 2</a>. It is represented by the big blue box in the picture above. </p>
<p>The second network &quot;project1&quot; is an internal network created specifically for this project, so all the project's services
can communicate with each other but keep encapsulated in a private network, disconnected from the outside world.
It is represented by the yellow boxes in the picture above.</p>
<pre><code class="language-yaml">networks:
  default:
    external:
      name: gateway

  project1:
    internal: true</code></pre>
<p>The webserver of the application is - as the only exception - connected to both networks, so we can route traffic
from the outside into the application. If we look at the nginx service configuration there are two notable things:</p>
<pre><code class="language-yaml">  nginx:
    image: nginx
    container_name: "project1_nginx"
    volumes:
    - ./:/app:ro
    - ./.docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: "always"
    labels:
      - "traefik.frontend.rule=HostRegexp:{subdomain:[a-z]+}.project1.com"
    networks:
    - default
    - project1</code></pre>
<p>First, under <code>networks:</code> both defined networks are listed, which means nginx can communicate with whatever is in the
&quot;default&quot; (a.k.a. &quot;gateway&quot;) network and whatever is in the &quot;project1&quot; network.</p>
<p>Second, under <code>labels:</code> a frontend rule for traefik was defined, saying that traefik should route all traffic for
<code>*.project1.com</code> to this nginx instance. This is basically how the domains are assigned to the development projects.</p>
<p>The <code>composer</code> service is connected only to the &quot;default&quot; (a.k.a. &quot;gateway&quot; network) because it needs internet access
which is not avaialable from the internal network &quot;project1&quot;. On the other hand the composer service does not need any
connection to the other containers of the setup, but the filesystem mount. </p>
<h4>project1/composer.json</h4>
<p>Just a more or less empty composer json, so that the composer service has something to do.</p>
<pre><code class="language-json">{
  "name": "traefik-routing/project1",
  "description": "Example project 1 for reverse-proxy routing using traefik",
  "license": "MIT",
  "require": {},
  "require-dev": {
    "roave/security-advisories": "dev-master"
  }
}</code></pre>
<h4>project1/.docker/nginx/default.conf</h4>
<p>The configuration for the nginx webserver looks as follows:</p>
<pre><code class="language-nginx">server {
    listen 80;
    server_name dev.project1.com;

    root /app/public;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }
}

server {
    listen 80;
    server_name readis.project1.com;

    location / {
        proxy_pass http://readis:80;
    }
}</code></pre>
<p>As you can see there are two servers/sub-domains defined:</p>
<ul>
<li>
<p><code>dev.project1.com</code> passes traffic via FastCGI to the php-fpm instance on port 9000 - the <code>php</code> service in the docker-compose setup.<br />
The important line is:</p>
<pre><code class="language-nginx">fastcgi_pass php:9000;</code></pre>
</li>
<li><code>readis.project1.com</code> passes HTTP traffic to the re<sup>a</sup>dis instance on port 80 - the <code>readis</code> service in the docker-compose setup.
The important line is:
<pre><code class="language-nginx">proxy_pass http://readis:80;</code></pre></li>
</ul>
<p>Both defined servers only listen on port 80, because the SSL offloading will be done by traefik centrally,
which then sends traffic to its backends unencrypted via HTTP on port 80.</p>
<h4>project1/.docker/php/Dockerfile</h4>
<p>This is the docker image configuration file that is used to build the php-fpm image with some needed extensions.
In this case we especially need the <code>pdo_mysql</code> and <code>redis</code> extension (<a href="https://github.com/phpredis/phpredis">phpredis</a>) in order to connect to the MariaDB and redis instances.</p>
<p>And as we are in development environment I usually also enable <a href="https://php.net/opcache">OPCache</a> and install <a href="https://xdebug.org">Xdebug</a>.</p>
<pre><code class="language-dockerfile">FROM php:7.3-fpm-alpine
ENV PHPREDIS_VERSION 4.3.0
ENV XDEBUG_VERSION 2.7.1
# Update system
RUN apk update &amp;&amp; apk upgrade &amp;&amp; apk add --no-cache ${PHPIZE_DEPS} procps \
    &amp;&amp; pecl install xdebug-${XDEBUG_VERSION} \
    &amp;&amp; docker-php-ext-enable xdebug \
    &amp;&amp; docker-php-ext-configure opcache --enable-opcache \
    &amp;&amp; docker-php-ext-install opcache pdo_mysql
# Install redis extension
RUN mkdir -p /usr/src/php/ext/redis \
   &amp;&amp; curl -L https://github.com/phpredis/phpredis/archive/${PHPREDIS_VERSION}.tar.gz | tar xvz -C /usr/src/php/ext/redis --strip 1 \
   &amp;&amp; echo 'redis' &gt;&gt; /usr/src/php-available-exts \
   &amp;&amp; docker-php-ext-install redis
# Cleanup
RUN apk del ${PHPIZE_DEPS} \
    &amp;&amp; rm -rf /var/cache/apk/*
WORKDIR /app</code></pre>
<h4>project1/.docker/readis/app.php</h4>
<p>This config file is required by re<sup>a</sup>dis to set up the base URL of the redis web UI.</p>
<pre><code class="language-php">&lt;?php

return [
    'baseUrl' =&gt; 'https://readis.project1.com',
];</code></pre>
<h4>project1/.docker/readis/servers.php</h4>
<p>This config file is required by re<sup>a</sup>dis to set up the available redis server instances for the web UI.</p>
<p><strong>Please note</strong> that the host name must be the service name &quot;redis&quot; that was defined in the <code>docker-compose.yml</code>.</p>
<pre><code class="language-php">&lt;?php

return [
    [
        'name'          =&gt; 'Redis-Server Project 1',
        'host'          =&gt; 'redis',
        'port'          =&gt; 6379,
        'auth'          =&gt; null,
        'timeout'       =&gt; 2.5,
        'retryInterval' =&gt; 100,
        'databaseMap'   =&gt; [
            0 =&gt; 'Project 1 sessions',  
        ],
    ],
];</code></pre>
<h4>project1/public/index.php</h4>
<p>This is the actual test application that will access the database and store sessions in redis.
In order to keep it simple I just connect to both services (&quot;db&quot; &amp; &quot;redis&quot;) and echo some data.</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

ini_set( 'session.name', 'SIDP1' );
ini_set( 'session.save_handler', 'redis' );
ini_set( 'session.save_path', 'tcp://redis:6379?weight=1&amp;database=0' );
ini_set( 'session.gc_maxlifetime', '84400' );

session_set_cookie_params( 84400, '/', 'dev.project1.com', true, true );

session_start();

$pdo = new PDO('mysql:host=db;port=3306', 'root', 'root');
$statement = $pdo-&gt;query("SELECT 'This is the DB of project 1'");

header('Content-Type: text/html; charset=utf-8', true, 200);
printf('&lt;h1&gt;%s&lt;/h1&gt;', $statement-&gt;fetchColumn() );
printf('&lt;p&gt;Your session ID is: %s=%s&lt;/p&gt;', session_name(), session_id());</code></pre>
<h4>Bring up project1</h4>
<p>Now let' start the docker-compose setup for project 1 with the following command.</p>
<pre><code class="language-bash">$ cd /path/to/project1
/path/to/project1 $ docker-compose up -d</code></pre>
<p>Check with <code>docker-compose ps</code> if all containers are up and running. You should see something like this:</p>
<pre><code class="language-text">      Name                     Command               State    Ports
--------------------------------------------------------------------
project1_composer   /bin/sh /docker-entrypoint ...   Exit 1
project1_db         docker-entrypoint.sh mysqld      Up
project1_nginx      nginx -g daemon off;             Up       80/tcp
project1_php        docker-php-entrypoint php-fpm    Up
project1_readis     docker-php-entrypoint php  ...   Up
project1_redis      docker-entrypoint.sh redis ...   Up</code></pre>
<p>As soon as your setup is up you can check the traefik dashboard again and should see that there had a new
frontend and backend been discovered.</p>
<p><a href="https://dev.hollo.me/img/posts/traefik-dashboard-project1.png"><img src="https://dev.hollo.me/img/posts/traefik-dashboard-project1.png" alt="traefik dashboard with project 1 running" /></a></p>
<h4>Bring up project2</h4>
<p>Now we can also start project 2 and should see the same effect in the traefik dashboard.</p>
<pre><code class="language-bash">$ cd /path/to/project2
/path/to/project2 $ docker-compose up -d</code></pre>
<p>Check with <code>docker-compose ps</code> if all containers are up and running. You should see something like this:</p>
<pre><code class="language-text">      Name                     Command               State    Ports
--------------------------------------------------------------------
project2_composer   /bin/sh /docker-entrypoint ...   Exit 1
project2_db         docker-entrypoint.sh mysqld      Up
project2_nginx      nginx -g daemon off;             Up       80/tcp
project2_php        docker-php-entrypoint php-fpm    Up
project2_readis     docker-php-entrypoint php  ...   Up
project2_redis      docker-entrypoint.sh redis ...   Up</code></pre>
<p>Now the traefik dashboard should look like this:</p>
<p><a href="https://dev.hollo.me/img/posts/traefik-dashboard-project2.png"><img src="https://dev.hollo.me/img/posts/traefik-dashboard-project2.png" alt="traefik dashboard with project 1 & 2 running" /></a></p>
<p>You can find both example projects in <a href="https://github.com/hollodotme/treafik-proxy-projects">this git repository</a>.</p>
<p><strong>We are almost there!</strong></p>
<p><a name="chapter-4"></a></p>
<h3>CHAPTER 4: Domain resolution</h3>
<p>In order to open the four sub-domains that we have configured we need to make sure that they will be resolved locally,
so traefik can pick up the requests.</p>
<p>The easiest way to do this is put all four domains in your <code>/etc/hosts</code> file once and point them to <code>127.0.0.1</code>.</p>
<pre><code class="language-text">127.0.0.1   dev.project1.com readis.project1.com
127.0.0.1   dev.project2.com readis.project2.com</code></pre>
<p>Now we're ready to go!</p>
<ul>
<li>
<p><a href="https://dev.project1.com">https://dev.project1.com</a>
<a href="https://dev.hollo.me/img/posts/dev-project1-com.png"><img src="https://dev.hollo.me/img/posts/dev-project1-com.png" alt="dev.project1.com" /></a></p>
</li>
<li>
<p><a href="https://readis.project1.com/server/0/">https://readis.project1.com/server/0/</a>
<a href="https://dev.hollo.me/img/posts/readis-project1-com.png"><img src="https://dev.hollo.me/img/posts/readis-project1-com.png" alt="readis.project1.com" /></a></p>
</li>
<li>
<p><a href="https://dev.project2.com">https://dev.project2.com</a>
<a href="https://dev.hollo.me/img/posts/dev-project2-com.png"><img src="https://dev.hollo.me/img/posts/dev-project2-com.png" alt="dev.project2.com" /></a></p>
</li>
<li><a href="https://readis.project2.com/server/0/">https://readis.project2.com/server/0/</a>
<a href="https://dev.hollo.me/img/posts/readis-project2-com.png"><img src="https://dev.hollo.me/img/posts/readis-project2-com.png" alt="readis.project2.com" /></a></li>
</ul>
<hr />
<p><a name="summary"></a></p>
<h3>SUMMARY</h3>
<p>What we have accomplished:</p>
<ul>
<li>We can create locally-trusted SSL certificates with <a href="https://github.com/FiloSottile/mkcert#install">mkcert</a>.</li>
<li>We set up a global reverse-proxy with <a href="https://traefik.io">traefik</a> that centrally handles SSL offloading and we can attach any HTTP server to it by connecting to a gateway network and setting a simple label in a docker-compose configuration.</li>
<li>We set up an autostart mechanism for the traefik instance.</li>
<li>We started two independent web projects in docker-compose setups and made their sub-domains available through traefik.</li>
</ul>
<p>When starting a new project the following steps have to be taken (once):</p>
<ol>
<li>Create a new SSL certificate using <code>mkcert</code> an place it to <code>~/ssl</code>.
<pre><code class="language-bash">~/ssl $ mkcert "*.new-domain.com"</code></pre></li>
<li>Reference the newly created SSL files in <code>~/traefik/traefik.toml</code> 
<pre><code class="language-toml">[[entryPoints.https.tls.certificates]]
certFile = "/etc/traefik/ssl/_wildcard.new-domain.com.pem"
keyFile = "/etc/traefik/ssl/_wildcard.new-domain.com-key.pem"</code></pre>
<p>and restart traefik.</p>
<pre><code class="language-bash">~/traefik $ docker-composer up -d --force-recreate</code></pre></li>
<li>Add the new (sub-)domain(s) to your <code>/etc/hosts</code>.
<pre><code class="language-text">127.0.0.1   sub.new-domain.com</code></pre></li>
<li>Add the &quot;default&quot; (a.k.a. &quot;gateway&quot;) network and traefik label to the target service in your new <code>docker-compose.yml</code>
<pre><code class="language-yml">labels:
 - "traefik.frontend.rule=HostRegexp:{subdomain:[a-z]+}.new-domain.com"
networks:
 - default
 - projectNew</code></pre></li>
<li>Fire up your new project with docker-compose and you're good to go.
<pre><code class="language-bash">/path/to/new-project $ docker-compose up -d</code></pre></li>
</ol>
<hr />
<p><small>04/22/2019</small></p>

		
	</div>
</div>
<script src="https://dev.hollo.me/js/theme.js"></script>
<script src="https://dev.hollo.me/js/prism.js"></script>
<link rel="stylesheet" href="https://dev.hollo.me/css/prism.css">
</body>
</html>
